#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ú–ü–ò –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
"""

import psycopg2
from config import Config

def get_db_connection():
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    try:
        db_config = {
            'host': Config.DB_HOST,
            'port': Config.DB_PORT,
            'database': Config.DB_NAME,
            'user': Config.DB_USER,
            'password': Config.DB_PASSWORD
        }
        return psycopg2.connect(**db_config)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {e}")
        return None

def update_mpi_manually():
    """–†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ú–ü–ò –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –°–ò"""
    
    # –°–ª–æ–≤–∞—Ä—å —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –ú–ü–ò –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –°–ò
    known_mpi = {
        '72915-18': '2 –≥–æ–¥',  # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —Å–∏–≥–Ω–∞–ª–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã
        '9364-08': '2 –≥–æ–¥',   # –ì–∏–≥—Ä–æ–º–µ—Ç—Ä—ã –ø—Å–∏—Ö—Ä–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ
        '42593-09': '1 –≥–æ–¥',  # –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã —Å–ø–µ–∫—Ç—Ä–∞
        '42594-09': '1 –≥–æ–¥',  # –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã —Å–ø–µ–∫—Ç—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        '19818-00': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '52059-12': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '54631-13': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '57587-14': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '59778-15': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '75676-19': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '22128-07': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '26950-04': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '26951-04': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '29967-05': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '31045-06': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '32050-06': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '35423-07': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '36974-08': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '37008-08': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '38428-08': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '44402-10': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '45328-10': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '47185-11': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '48469-11': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '48998-12': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '49916-12': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '50593-12': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '52071-12': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '52705-13': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '55491-13': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '55499-13': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '56450-14': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '57386-14': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '58755-14': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '60181-15': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '60404-15': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '61553-15': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '65890-16': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '68540-17': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '69452-17': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '70557-18': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '71344-18': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '72189-18': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '72879-18': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '72922-18': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '75840-19': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '76369-19': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '78610-20': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '79042-20': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '79635-20': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '80307-20': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '80595-20': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '87757-22': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '91177-24': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '91351-24': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
        '91448-24': '2 –≥–æ–¥',  # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ú–ü–ò
    }
    
    conn = get_db_connection()
    if not conn:
        return
    
    cursor = conn.cursor()
    
    try:
        updated_count = 0
        
        for gosregister_number, mpi_value in known_mpi.items():
            # –û–±–Ω–æ–≤–ª—è–µ–º –ú–ü–ò –≤ gosregister
            cursor.execute('''
                UPDATE gosregister 
                SET mpi = %s, updated_at = CURRENT_TIMESTAMP
                WHERE gosregister_number = %s
            ''', (mpi_value, gosregister_number))
            
            if cursor.rowcount > 0:
                updated_count += cursor.rowcount
                print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –ú–ü–ò –¥–ª—è {gosregister_number}: {mpi_value}")
            else:
                print(f"‚ö†Ô∏è  –ó–∞–ø–∏—Å—å {gosregister_number} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ú–ü–ò –≤ equipment
        cursor.execute('''
            UPDATE equipment 
            SET mpi = g.mpi
            FROM gosregister g
            WHERE equipment.gosregister_id = g.id 
            AND g.mpi IS NOT NULL 
            AND g.mpi != ''
            AND (equipment.mpi IS NULL OR equipment.mpi != g.mpi)
        ''')
        
        synced_count = cursor.rowcount
        print(f"‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ {synced_count} –∑–∞–ø–∏—Å–µ–π –ú–ü–ò –≤ equipment")
        
        conn.commit()
        print(f"\n‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ {updated_count} –∑–∞–ø–∏—Å–µ–π –ú–ü–ò –≤ gosregister")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ú–ü–ò: {e}")
        conn.rollback()
    finally:
        cursor.close()
        conn.close()

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("üöÄ –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ú–ü–ò...")
    update_mpi_manually()
    print("‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")

if __name__ == "__main__":
    main()
