# Скрипты для резервного копирования и восстановления PostgreSQL

Набор PowerShell скриптов для создания резервных копий и восстановления базы данных PostgreSQL.

## Требования

- PostgreSQL клиентские утилиты (`pg_dump`, `psql`, `pg_restore`)
- PowerShell 5.1 или выше
- Доступ к серверам PostgreSQL
- Файл `settings.txt` с настройками подключения

## Настройки подключения

Все параметры подключения к БД хранятся в файле `settings.txt`:

```
DB_USER=postgres
DB_PASSWORD=27915002
DB_NAME=equipment
DB_HOST139=192.168.1.139
DB_HOST22=192.168.1.22
DB_PORT=5432
```

- `DB_HOST139` - исходный сервер для резервного копирования
- `DB_HOST22` - целевой сервер для восстановления

## Использование

### 1. Создание резервной копии

Создает резервную копию базы данных `equipment` с сервера `192.168.1.139`:

```powershell
.\backup_database.ps1
```

**Параметры:**
- `-SourceHost` - IP адрес исходного сервера (по умолчанию: 192.168.1.139)
- `-Database` - имя базы данных (по умолчанию: equipment)
- `-Port` - порт PostgreSQL (по умолчанию: 5432)
- `-Username` - имя пользователя (по умолчанию: postgres)
- `-BackupPath` - путь для сохранения бэкапов (по умолчанию: .\backups)
- `-BackupFile` - полный путь к файлу бэкапа (если не указан, генерируется автоматически)

**Примеры:**

```powershell
# Базовое использование
.\backup_database.ps1

# С указанием пользователя
.\backup_database.ps1 -Username myuser

# С указанием конкретного файла
.\backup_database.ps1 -BackupFile ".\backups\my_backup.sql"
```

### 2. Восстановление базы данных

Восстанавливает базу данных `equipment` на сервере `192.168.1.22`:

```powershell
.\restore_database.ps1 -BackupFile ".\backups\equipment_backup_20240101_120000.sql"
```

**Параметры:**
- `-TargetHost` - IP адрес целевого сервера (по умолчанию: 192.168.1.22)
- `-Database` - имя базы данных (по умолчанию: equipment)
- `-Port` - порт PostgreSQL (по умолчанию: 5432)
- `-Username` - имя пользователя (по умолчанию: postgres)
- `-BackupFile` - путь к файлу резервной копии (если не указан, используется последний найденный)
- `-CreateDatabase` - создавать базу данных, если не существует (по умолчанию: true)

**Примеры:**

```powershell
# Восстановление с автоматическим поиском последнего бэкапа
.\restore_database.ps1

# Восстановление с указанием файла
.\restore_database.ps1 -BackupFile ".\backups\equipment_backup_20240101_120000.sql"

# Восстановление без создания БД (если уже существует)
.\restore_database.ps1 -BackupFile ".\backups\backup.sql" -CreateDatabase:$false
```

## Процесс работы

### Создание резервной копии

1. Скрипт создает директорию `backups` (если её нет)
2. Генерирует имя файла с timestamp: `equipment_backup_YYYYMMDD_HHMMSS.sql`
3. Запрашивает пароль для подключения к БД
4. Выполняет `pg_dump` для создания SQL дампа
5. Сохраняет файл в указанную директорию

### Восстановление

1. Проверяет наличие файла резервной копии
2. Проверяет существование целевой базы данных
3. Создает базу данных, если её нет (если `-CreateDatabase` включен)
4. Восстанавливает структуру и данные из SQL файла
5. Выводит количество восстановленных таблиц

## Безопасность

- Пароли хранятся в файле `settings.txt` (не рекомендуется для продакшн)
- Переменные окружения с паролями очищаются после выполнения
- Используется флаг `--if-exists` для безопасной очистки при восстановлении
- Для продакшн рекомендуется использовать переменные окружения или безопасное хранилище паролей

## Примечания

- Убедитесь, что пользователь PostgreSQL имеет права на создание/удаление базы данных
- При восстановлении существующие объекты будут удалены (используется `--clean`)
- Рекомендуется делать резервную копию перед восстановлением на продакшн сервере

