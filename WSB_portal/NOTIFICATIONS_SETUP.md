# Настройка системы уведомлений

## Обзор

Система уведомлений отправляет email-сообщения пользователям при создании и отмене бронирований, а также администраторам при обнаружении конфликтов.

## Настройка SMTP

### 1. Добавьте переменные окружения в `.env`

```env
# SMTP настройки
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM_EMAIL=your-email@gmail.com
SMTP_FROM_NAME=WSB Portal
ENABLE_EMAIL=true
```

### 2. Настройка Gmail

Для использования Gmail необходимо:

1. Включить двухфакторную аутентификацию в аккаунте Google
2. Создать "Пароль приложения":
   - Перейдите в настройки аккаунта Google
   - Выберите "Безопасность" → "Двухэтапная аутентификация"
   - Найдите "Пароли приложений"
   - Создайте новый пароль приложения для "Почта"
   - Используйте этот пароль в `SMTP_PASSWORD`

### 3. Другие почтовые сервисы

**Yandex:**
```env
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
SMTP_USER=your-email@yandex.ru
SMTP_PASSWORD=your-password
```

**Mail.ru:**
```env
SMTP_HOST=smtp.mail.ru
SMTP_PORT=465
SMTP_USER=your-email@mail.ru
SMTP_PASSWORD=your-password
```

**Корпоративный сервер:**
```env
SMTP_HOST=smtp.your-company.com
SMTP_PORT=587
SMTP_USER=your-email@your-company.com
SMTP_PASSWORD=your-password
```

## Создание таблицы настроек

Перед использованием уведомлений необходимо создать таблицу `notification_settings`:

```bash
cd C:\Soft_IPK\WSB_portal
python scripts/create_notification_settings_table.py
```

Скрипт автоматически:
- Создаст таблицу `notification_settings`
- Создаст настройки по умолчанию для всех существующих пользователей (email-уведомления включены)

## Режим разработки

Если `ENABLE_EMAIL=false` или настройки SMTP не указаны, уведомления будут логироваться в консоль, но не отправляться. Это полезно для разработки и тестирования.

## Типы уведомлений

### 1. Уведомление о создании бронирования
Отправляется пользователю при успешном создании бронирования. Содержит:
- Название оборудования
- Дата и время бронирования
- Подтверждение создания

### 2. Уведомление об отмене бронирования
Отправляется пользователю при отмене бронирования. Содержит:
- Название оборудования
- Дата и время отмененного бронирования
- Предупреждение о необходимости связаться с администратором, если отмена не была инициирована пользователем

### 3. Уведомление о конфликте (для администраторов)
Отправляется всем администраторам при попытке создать бронирование, которое конфликтует с существующим. Содержит:
- Название оборудования
- Запрашиваемое время
- Информацию о конфликтующем бронировании

## Настройки пользователей

Пользователи могут управлять своими настройками уведомлений через веб-интерфейс:
- Войти в систему
- Нажать на кнопку "Настройки уведомлений" в шапке
- Включить/выключить email-уведомления
- SMS-уведомления пока недоступны (в разработке)

## API

- `GET /auth/notification-settings` — получить текущие настройки
- `PUT /auth/notification-settings` — обновить настройки

## Логирование

Все попытки отправки уведомлений логируются в консоль:
- `[EMAIL SENT]` — успешная отправка
- `[EMAIL ERROR]` — ошибка отправки
- `[EMAIL DISABLED]` — отправка отключена
- `[EMAIL CONFIG MISSING]` — отсутствуют настройки SMTP
- `[EMAIL INVALID]` — неверный email-адрес

