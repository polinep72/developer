# Changelog — WSB Portal

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/) и [SemVer](https://semver.org/lang/ru/).

## [Unreleased]

## [0.3.8] - 2025-12-04
### Fixed
- Исправлено автоматическое обновление тепловой карты при переходе на вкладку "Бронирование оборудования": теперь программно нажимается кнопка "Показать занятость", что гарантирует использование всей существующей логики обновления
- Упрощена логика обновления тепловой карты: удалена сложная система множественных попыток, заменена на простой программный клик по кнопке

## [0.3.7] - 2025-12-03
### Fixed
- Исправлены ошибки отступов (IndentationError) в `heatmap.py` и `dashboard.py` после восстановления файлов
- Исправлено переполнение блоков на подвкладках "Статистика по оборудованию" и "Статистика по пользователям": блоки больше не выходят за края страницы браузера
- Добавлена горизонтальная прокрутка для широких таблиц в расширенной статистике
- Добавлены ограничения ширины для контейнеров статистики (max-width: 100%, overflow-x: hidden)

## [0.3.6] - 2025-12-01
### Fixed
- Тепловая карта для сегодняшней даты больше не кэшируется, статусы слотов корректно переходят из "Забронировано" в "В работе" по реальному времени
- Добавлен параметр LOCAL_TIME_OFFSET_MINUTES для учёта часового пояса (по умолчанию МСК +180 минут)
- Исправлена docker-compose конфигурация Redis: убран конфликт порта 6379, Redis используется только внутри Docker-сети
- Добавлены скрипты запуска и мониторинга контейнеров (start-and-monitor.bat, monitor-logs.ps1/.bat)

## [0.3.5] - 2025-11-26
### Added
- Проведен полный аудит проекта: безопасность, UX/UI, дополнительные фичи, рекомендации (см. `PROJECT_AUDIT_FULL.md`)
- Расширенная аналитика для подвкладок "Статистика по оборудованию" и "Статистика по пользователям":
  - Детальная статистика (количество бронирований, средняя длительность, процент загрузки, разнообразие оборудования)
  - Графики распределения по дням недели
  - Графики пиковых часов использования/работы
  - Графики динамики использования по месяцам
  - Топ пользователей для каждого оборудования
  - Часто используемое оборудование для каждого пользователя
- Блок "ВЫВОД:" в разделе "Пиковые инциденты" с рекомендациями по расширению парка оборудования
- Восстановление пароля через корпоративный email с отправкой токена и ссылки

### Changed
- Расширен интервал времени бронирования: начало с 7:00, окончание до 22:00 (было 8:00-20:00)
- Блок "Использование по категориям" переименован в "Использование оборудования" и показывает конкретное оборудование вместо категорий
- Логика "Пиковых инцидентов" исправлена: теперь показываются кратковременные перегрузки (дни с использованием >10 часов), а не недогруженное оборудование
- Рекомендации по расширению парка в "Пиковых инцидентах" собраны в один блок "ВЫВОД:" в конце раздела
- Блоки в расширенной статистике расположены вертикально друг под другом вместо сетки
- Графики "Топ оборудования" и "Топ пользователей" настроены для корректного отображения в контейнерах (поворот подписей, отступы)

### Fixed
- Исправлено отображение графиков: графики больше не выходят за границы блоков
- Исправлена логика рекомендаций: категория "Без категории" исключена из групповых рекомендаций, показываются конкретные названия оборудования

## [0.3.5] - 2025-11-26
### Added
- Восстановлена расширенная аналитика на вкладке "История бронирований" с подвкладками: Даш-борд, Тепловая карта, Статистика по оборудованию, Статистика по пользователям, Временные паттерны, Прогноз загрузки, Рекомендации
- Интерактивные подсказки (tooltips) для фильтров и аналитических блоков
- Настраиваемый дашборд: возможность скрывать/переставлять виджеты, настройки сохраняются в браузере
- Новые показатели дашборда: топ категорий по загрузке, время подготовки (lead time), доля выходных/праздничных бронирований
- Информационные заметки о периоде данных (6 месяцев) на всех подвкладках расширенной аналитики

### Changed
- Перестроена структура вкладки "История бронирований" на систему подвкладок
- Легенды графиков перенесены в верхнюю часть с горизонтальной ориентацией
- Улучшена верстка дашборда: виджеты вынесены в отдельные карточки
- Обновлены стили для предотвращения переполнения графиков за границы контейнеров

### Fixed
- Исправлены SQL запросы в dashboard.py: убраны несуществующие таблицы (categories) и поля (created_at)
- Исправлена логика получения данных: теперь используются реальные данные из БД вместо демо-данных
- Исправлена логика доступа к вкладкам: для неавторизованных пользователей скрыты "Управление бронированием" и "Календарь бронирований"
- Добавлена защита от переключения на скрытые вкладки

## [0.3.4] - 2025-11-26
### Fixed
- export_excel.py: устранено 59 ошибок Pyright (типобезопасный доступ к листам и ячейкам)

## [0.3.3] - 2025-11-26
### Fixed
- Кнопка «Отменить» на вкладке «Управление бронированием» теперь доступна только для сегодняшних и будущих дат; для прошедших бронирований действие скрыто

## [0.3.2] - 2025-11-26
### Fixed
- Исправлена логика перехода из календаря в "Управление бронированием": теперь при клике на дату в календаре автоматически загружаются данные именно за выбранную дату, а не за текущую
- Исправлены ID элементов в обработчике клика календаря (`manage-booking-date` вместо `manage-bookings-date`, `refresh-bookings` вместо `dashboard-apply`)
- Добавлена проверка установки даты перед загрузкой данных для предотвращения загрузки данных за неправильную дату

## [0.3.1] - 2025-11-26
### Added
- Скрытие вкладки "Управление бронированием" для неавторизованных пользователей
- Автоматическое переключение на доступную вкладку при попытке доступа к закрытой
- Логика контроля доступа к вкладкам на основе авторизации пользователя
- Вкладка "Календарь бронирований" с месячным представлением бронирований
- API endpoint `/api/bookings/calendar` для получения данных календаря
- Функция `get_calendar_overview()` для получения статистики бронирований по дням месяца
- Автоматическая остановка предыдущих экземпляров сервера при запуске (функция `stop_previous_instances()`)
- Функция `get_optional_user()` для работы с неавторизованными пользователями

### Changed
- Для неавторизованных пользователей доступны только 3 вкладки: "Бронирование оборудования", "История бронирований", "Система учета оборудования"
- При запуске сервера автоматически останавливаются все предыдущие экземпляры на порту 8090

## [0.3.0] - 2025-11-25
### Added
- Поля поиска и фильтры статуса поверки для всех подвкладок «Система учета оборудования»
- Шрифты `DejaVuSans`/`DejaVuSans-Bold` в `app/static/fonts` и подключение их в `export_pdf.py` для корректного отображения кириллицы в PDF-отчётах
- Документ с предложениями по улучшению (IMPROVEMENTS.md)
- Результаты проверки проекта (PROJECT_REVIEW.md)
- Полная проверка проекта и аудит незавершенных задач (PROJECT_AUDIT.md)
- Конкретные сценарии деплоя и мониторинга в SYNC_INSTRUCTIONS.md
- Docker-конфигурация: Dockerfile, docker-compose.yml, .dockerignore
- Инструкция по использованию Docker (DOCKER_SETUP.md)
- Health checks для контейнеров приложения и Redis
- Вкладка "Управление пользователями" для администраторов (создание, редактирование, удаление пользователей, сброс паролей)
- API-эндпоинты для управления пользователями: `/api/users`, `/api/users/{user_id}`, `/api/users/{user_id}/reset-password`
- Регистрация новых пользователей через веб-интерфейс (`/register`)
- API-эндпоинт `POST /auth/register` для регистрации с Telegram ID
- Страница регистрации с инструкцией по получению Telegram ID через @userinfobot
- Система email-уведомлений о бронированиях (создание, отмена, конфликты)
- Сервис `notifications.py` для отправки email-уведомлений
- Таблица `notification_settings` для настроек уведомлений пользователей
- API-эндпоинты для управления настройками уведомлений: `GET /auth/notification-settings`, `PUT /auth/notification-settings`
- UI для настроек уведомлений в профиле пользователя
- Уведомления администраторам о конфликтах бронирований
- Сервис `cache.py` с подключением к Redis, декоратором `@cached` и функциями инвалидации
- Кеширование тепловых карт, дашборда, списков категорий/оборудования и данных модуля СИ
- Документ `REDIS_SETUP.md` с инструкциями по установке и настройке Redis (256 MB)
- Планировщик APScheduler для автоматических напоминаний за 15 минут до начала работы
- Сервис `booking_reminders.py` и таблица `booking_reminders_sent` для учёта отправленных напоминаний
- Групповые email-уведомления о начале работы (одно письмо со списком ближайших бронирований)
- Скрипт `scripts/create_indexes.py` для создания индексов (таблица `bookings` в БД RM и ключевые таблицы БД `equipment`)
- Экспорт бронирований (CSV) на вкладке «Управление бронированием» через `/api/bookings/export`

### Fixed
- Столбцы «Категория / Пользователь / Статус» в экспортируемых CSV/XLSX теперь заполняются в правильном порядке

## [0.3.0] - 2025-11-25
### Added
- Экспорт бронирований, дашборда и данных модуля СИ в PDF (новый сервис `export_pdf.py`, API-эндпоинты и кнопки в интерфейсе)
- Кнопки «Экспорт PDF» на вкладках «Управление бронированием», «История бронирований» и во всех подвкладках СИ
- Новая зависимость `reportlab==4.2.5` для генерации PDF

### Changed
- Унифицирована высота кнопок (ориентир «+ Добавить пользователя») и увеличен логотип в шапке
- Кнопки экспорта сгруппированы и подогнаны по высоте к полям выбора даты

### Changed
- Название столбца "Имя" изменено на "Имя, Отчество" в таблице пользователей
- Логика напоминаний объединяет несколько бронирований пользователя в одно письмо и учитывает настройки уведомлений
- Уведомления используют SMTP-аккаунт WSB (`ENABLE_EMAIL`, `SMTP_*`) с обработкой ошибок авторизации
- Вкладка «История бронирований» по умолчанию отображает последние 90 дней, запросы `/api/dashboard` фильтруют диапазон на уровне SQL вместо загрузки всей истории
- Запросы модуля СИ (`get_equipment_by_type`, `get_gosregister`) возвращают только используемые столбцы, что ускоряет выдачу таблиц

## [0.2.0] - 2025-11-20
### Added
- Инициализация подпроекта `WSB_portal` и документации
- Определение назначения, связей и плана интеграции с WSB
- FastAPI-приложение на `8090` с вкладкой «Бронирование оборудования» и Plotly-тепловой картой
- Собственный дашборд бронирования рабочих мест (фильтры, графики, таблицы) без внешнего iframe, историческая тепловая карта с контролем дат
- Подключён фирменный логотип ИПК «Электрон-Маш» в шапке портала
- Сводка «Активные брони / Свободные слоты» на первой вкладке, данные берутся из сервиса тепловой карты
- Веб-форма бронирования (категория → оборудование → время → длительность) с REST-API и проверкой пересечений
- Система авторизации пользователей (JWT, вход по телефону/email, смена пароля, восстановление пароля)
- Вкладка «Управление бронированием» с просмотром и отменой бронирований (раздельный доступ для пользователей и администраторов)
- Интеграция модуля «Система учета оборудования (СИ)» с четырьмя подвкладками (СИ, ИО, ВО, Госреестр) и функционалом добавления оборудования
- Светлоголубая сетка на тепловых картах для визуального разделения интервалов
- Поддержка HTML-тегов (`<br>`) в текстовых полях модуля СИ
- Кликабельные ссылки для номеров свидетельств и Госреестра

### Changed
- Поддержаны переменные окружения `POSTGRE_*` и `DB_*`, конфигурация загружается из `.env` (python-dotenv)
- Переименована вкладка дашборда в «История бронирований (статистика и графики)», переработаны стили вкладок и адаптивное отображение графиков/тепловых карт
- Переименована первая вкладка с «Бронирование измерительного оборудования (WSB)» на «Бронирование оборудования»
- Переименован блок «Бронирование рабочих мест» в «Бронирование оборудования»
- Оптимизирована компоновка первой вкладки: сводка перемещена в шапку, элементы управления подняты выше
- Легенда тепловой карты изменена с числовых значений (0,1,2,3) на текстовые («Свободно», «Забронировано», «В работе», «Завершено»)
- Формат даты в таблице управления бронированием изменён на `DD.MM.YYYY`

### Fixed
- Исправлено некорректное масштабирование графиков Plotly и исторической тепловой карты (растяжение на всю ширину, скрытие легенды «Состояние», выбор даты «вчера» по умолчанию)
- Исправлена нормализация телефонных номеров при входе (поддержка различных форматов)
- Исправлено отображение тепловых карт: блоки теперь квадратные (высота равна ширине)
- Исправлена обработка ошибок при загрузке данных модуля СИ
- Исправлен порядок маршрутов API для корректной работы `/api/equipment/stats` и `/api/equipment/test-connection`

## [0.1.0] - 2025-11-19
### Added
- Создана структура файлов контекста для веб-портала

---

## Типы изменений
- **Added** — новые возможности
- **Changed** — обновленные функции
- **Fixed** — исправления ошибок
- **Removed** — удаленные возможности

[Unreleased]: https://example.com/wsb_portal/compare/v0.1.0...HEAD
[0.1.0]: https://example.com/wsb_portal/releases/tag/v0.1.0

