# История решений — WSB Portal

## 2025-11-19 — Инициализация веб-портала
- **Проблема:** отсутствовал веб-интерфейс для бронирования рабочих мест, пользователи работали только через Telegram-ботов.
- **Подпроект:** WSB_portal
- **Влияние:** пользователи WSB, администрация, инфраструктура WSB/heatmap
- **Причина:** необходимость предоставить веб-доступ без дублирования логики.
- **Решение:** создан подпроект `WSB_portal`, определены цели, структура и связь с существующими сервисами.
- **Статус:** выполнено.

## 2025-11-19 — Создание первой страницы портала
- **Проблема:** нужно показать бронирование рабочих мест и тепловую карту в одном веб-интерфейсе.
- **Решение:** развёрнут FastAPI-сервер c шаблоном на две вкладки; верхний блок — «Бронирование рабочих мест», ниже Plotly-график занятости, данные берутся из БД RM (при отсутствии кредов — демо-режим).
- **Статус:** выполнено, проверка на стенде Cursor (uvicorn).

## 2025-11-19 — Вкладка «Даш-борд бронирования рабочих мест»
- **Проблема:** нужно отобразить существующий Dash-дашборд (порт 8083) и историю бронирований на одной странице.
- **Решение:** добавлена вторая вкладка с встроенным iframe Dash-приложения и отдельной тепловой картой истории (дата ограничена `<= сегодня`, данные из БД RM). Переписан JS для двух тепловых карт.
- **Статус:** выполнено, зависимости `numpy` и `plotly` установлены локально для устранения предупреждений.

## 2025-11-19 — Перенос логики Dashboard в WSB_portal
- **Проблема:** iframe зависел от внешнего сервиса (порт 8083) и переставал работать после отключения Dash-приложения.
- **Решение:** реализован собственный модуль `dashboard.py`, который напрямую обращается к БД RM, строит графики Plotly и таблицы пользователей/оборудования; добавлены API `/api/dashboard/init` и `/api/dashboard/data`, обновлены шаблон, CSS и JS.
- **Статус:** выполнено, вкладка «Рабочие места» полностью автономна.

## 2025-11-19 — Унификация переменных окружения БД
- **Проблема:** портал ожидал переменные `DB_*`, а в `.env` использовались значения `POSTGRE_*`, из-за чего подключения не происходило.
- **Решение:** добавлена поддержка обоих наборов переменных и загрузка `.env` через `python-dotenv`; обновлена документация с инструкциями и примером заполнения.
- **Статус:** выполнено, параметры подключения подхватываются автоматически.

## 2025-11-19 — Улучшение UX дашборда и шапки портала
- **Проблема:** графики Plotly и историческая тепловая карта некорректно занимали ширину, легенда «Состояние» перекрывала область, вкладка имела неинформативное название, в шапке отсутствовал фирменный логотип.
- **Решение:** переработан JS (адаптивное масштабирование графиков/тепловых карт, предрасчёт ширины вкладок, история открывается на «вчера» и скрывает легенду), вкладка переименована в «История бронирований (статистика и графики)», шапка обновлена с логотипом `logo.webp`.
- **Статус:** выполнено, UI соответствует требованиям пользователя и готов к дальнейшему развитию (регистрация/вход).

## 2025-11-20 — Заполнение блока «Активные брони / Свободные слоты»
- **Проблема:** на первой вкладке в сводке «Активные брони» и «Свободные слоты» отображались прочерки, т.к. данные не передавались с сервера.
- **Решение:** сервис тепловой карты считает количество действующих/запланированных броней и свободных 30‑минутных слотов, API возвращает сводку вместе с графиком; шаблон и фронтенд обновляют показатели при загрузке и обновлении.
- **Статус:** выполнено, сводка показывает актуальные значения из БД RM (с поддержкой демо-режима).

## 2025-11-20 — Веб-форма бронирования рабочих мест
- **Проблема:** в веб-портале отсутствовал процесс бронирования, пользователи вынуждены были обращаться к Telegram-боту.
- **Решение:** создан сервис `bookings.py` (категории, оборудование, свободные интервалы, запись в `bookings`), добавлено REST-API и форма на первой вкладке: выбор категории → оборудования → времени начала (шаг 30 мин) → длительности, проверка пересечений и создание записи после авторизации.
- **Статус:** выполнено, бронирования можно оформлять напрямую через портал, а тепловая карта обновляется сразу после создания записи.

## 2025-11-20 — Система авторизации пользователей
- **Проблема:** Telegram ID-авторизация не подходит для веб-портала, нужна система входа по телефону/email с паролем.
- **Подпроект:** WSB_portal
- **Влияние:** все пользователи портала, администраторы
- **Причина:** необходимость веб-авторизации независимо от Telegram.
- **Решение:** 
  - Расширена таблица `users` в БД RM полями `phone`, `email`, `password_hash`
  - Реализован сервис `auth.py` с JWT-токенами, хранение в httponly cookies
  - Созданы страницы `/login` и `/reset-password`
  - Добавлены API: `/auth/login`, `/auth/logout`, `/auth/me`, `/auth/change-password`, `/auth/reset/request`, `/auth/reset/confirm`
  - Реализована нормализация телефонных номеров для входа
  - Создан скрипт `set_temp_passwords.py` для установки временных паролей существующим пользователям
  - Добавлена таблица `password_reset_tokens` для восстановления паролей
- **Статус:** выполнено, пользователи могут входить по телефону или email, админы имеют расширенные права.

## 2025-11-20 — Вкладка «Управление бронированием»
- **Проблема:** пользователи не могли просматривать и отменять свои бронирования через веб-интерфейс.
- **Решение:** добавлена вторая вкладка «Управление бронированием» с таблицей бронирований, фильтрацией по дате, раздельным отображением для обычных пользователей (только свои) и администраторов (все бронирования), функционал отмены бронирований с проверкой прав и статусов.
- **Статус:** выполнено, пользователи могут управлять своими бронированиями, админы видят все записи.

## 2025-11-20 — Интеграция модуля «Система учета оборудования (СИ)»
- **Проблема:** существующий модуль СИ работал на отдельном порту (8084) и требовал интеграции в единый портал.
- **Подпроект:** WSB_portal
- **Влияние:** пользователи, работающие с оборудованием, администраторы
- **Причина:** централизация всех функций в одном веб-портале.
- **Решение:** 
  - Создан сервис `equipment.py` для работы с отдельной БД `equipment`
  - Добавлена третья вкладка «Система учета оборудования (СИ)» с четырьмя подвкладками: СИ, ИО, ВО, Госреестр
  - Реализованы API для получения данных, статистики, сертификатов
  - Добавлена функциональность добавления оборудования (модальные формы)
  - Реализована поддержка HTML-тегов (`<br>`) в текстовых полях
  - Добавлены кликабельные ссылки для номеров свидетельств и Госреестра
  - Настроена отдельная конфигурация БД через переменные `EQUIPMENT_DB_*`
- **Статус:** выполнено, модуль СИ полностью интегрирован, внешний сервис на порту 8084 можно остановить.

## 2025-11-20 — Улучшение визуализации тепловых карт
- **Проблема:** тепловые карты не имели визуального разделения интервалов, что затрудняло чтение данных.
- **Решение:** добавлена светлоголубая сетка на тепловых картах (1-я и 3-я вкладки) через настройку `plot_bgcolor` и `gridcolor` в Plotly, улучшена читаемость интервалов.
- **Статус:** выполнено, сетка отображается корректно на обеих тепловых картах.

## 2025-11-20 — Оптимизация UI первой вкладки
- **Проблема:** элементы управления и сводка были разбросаны по странице, требовалась более компактная компоновка.
- **Решение:** 
  - Перемещена сводка «Активные брони / Свободные слоты» в карточку в шапке блока бронирования
  - Подняты выше поля «Дата бронирования», кнопка «Показать занятость» и блок «Создать бронирование»
  - Унифицированы размеры заголовков блоков на всех вкладках
  - Изменено название первой вкладки с «Бронирование измерительного оборудования (WSB)» на «Бронирование оборудования»
  - Изменено название блока с «Бронирование рабочих мест» на «Бронирование оборудования»
- **Статус:** выполнено, интерфейс стал более компактным и логичным.

## 2025-11-20 — Вкладка «Управление пользователями»
- **Проблема:** администраторы не могли управлять пользователями через веб-интерфейс, требовалось создавать и редактировать пользователей напрямую в БД.
- **Подпроект:** WSB_portal
- **Влияние:** администраторы системы
- **Причина:** необходимость централизованного управления пользователями без доступа к БД.
- **Решение:** 
  - Создан сервис `users.py` для управления пользователями (CRUD операции)
  - Добавлена пятая вкладка «Управление пользователями» (доступна только администраторам)
  - Реализованы API-эндпоинты: `/api/users` (GET, POST), `/api/users/{user_id}` (GET, PUT, DELETE), `/api/users/{user_id}/reset-password` (POST)
  - Добавлена таблица пользователей с возможностью создания, редактирования, удаления и сброса паролей
  - Реализованы модальные окна для создания/редактирования пользователей и сброса паролей
  - Добавлена проверка активных бронирований при удалении пользователя
  - Вкладка автоматически скрывается для не-администраторов
- **Статус:** выполнено, администраторы могут полностью управлять пользователями через веб-интерфейс.

## 2025-11-20 — Регистрация новых пользователей
- **Проблема:** новые пользователи не могли самостоятельно зарегистрироваться в системе, требовалось создание учетной записи администратором.
- **Подпроект:** WSB_portal
- **Влияние:** все новые пользователи системы
- **Причина:** необходимость самостоятельной регистрации для удобства пользователей.
- **Решение:** 
  - Создана страница регистрации `/register` с формой ввода всех необходимых данных
  - Реализована функция `register_user` в `auth.py` для регистрации с использованием Telegram ID как `users_id`
  - Добавлен API-эндпоинт `POST /auth/register` с валидацией всех полей
  - Форма регистрации включает: телефон (обязательно), email (опционально), Telegram ID (обязательно), имя/отчество, фамилию, пароль и подтверждение пароля
  - Добавлена инструкция по получению Telegram ID через бота @userinfobot
  - Реализована проверка на дубликаты (Telegram ID, телефон, email)
  - Добавлена ссылка на регистрацию на странице входа
- **Статус:** выполнено, пользователи могут самостоятельно регистрироваться в системе с указанием Telegram ID для совместимости с Telegram-ботом.

## 2025-11-20 — Система уведомлений о бронированиях
- **Проблема:** пользователи не получали уведомления о создании и отмене бронирований, администраторы не знали о конфликтах.
- **Подпроект:** WSB_portal
- **Влияние:** все пользователи системы, администраторы
- **Причина:** необходимость информирования пользователей о статусе их бронирований.
- **Решение:** 
  - Создан сервис `notifications.py` для отправки email-уведомлений через SMTP
  - Добавлена таблица `notification_settings` в БД RM для хранения настроек уведомлений пользователей
  - Реализованы функции отправки уведомлений: `send_booking_created_notification`, `send_booking_cancelled_notification`, `send_booking_conflict_notification`
  - Интегрированы уведомления в функции `create_booking` и `cancel_booking` в `bookings.py`
  - Добавлены API-эндпоинты: `GET /auth/notification-settings`, `PUT /auth/notification-settings`
  - Реализован UI для управления настройками уведомлений (модальное окно в профиле пользователя)
  - Добавлена поддержка настройки SMTP через переменные окружения
  - Реализована проверка настроек пользователя перед отправкой уведомлений
  - Уведомления администраторам отправляются при обнаружении конфликтов бронирований
- **Статус:** выполнено, пользователи получают email-уведомления о бронированиях, администраторы уведомляются о конфликтах.

## 2025-11-24 — Кеширование данных на Redis
- **Проблема:** тепловые карты, дашборд и справочники оборудования запрашивали БД напрямую, что приводило к повышенной нагрузке и задержкам.
- **Подпроект:** WSB_portal
- **Влияние:** все пользователи портала, БД RM и equipment
- **Причина:** необходимость ускорить интерфейс и сократить количество однотипных SQL-запросов.
- **Решение:**
  - Добавлен сервис `cache.py` с подключением к Redis (256 MB) и декоратором `@cached`
  - Кешируются тепловые карты (`heatmap.py`), данные дашборда (`dashboard.py`), каталоги бронирования (`bookings.py`) и модуль СИ (`equipment.py`)
  - Реализована инвалидация кеша при создании/отмене брони, добавлении записей в модуле СИ и обновлении справочников
  - Добавлена документация `REDIS_SETUP.md` и переменные окружения `REDIS_*`, `ENABLE_CACHE`
- **Статус:** выполнено, кэш автоматически используется при доступности Redis, при ошибках кеширование отключается без влияния на функционал.

## 2025-11-24 — Напоминания о начале работы (групповые письма)
- **Проблема:** пользователи не получали напоминаний перед началом работы с оборудованием, а при большом числе бронирований им бы приходило по несколько писем.
- **Подпроект:** WSB_portal
- **Влияние:** все пользователи, имеющие активные бронирования
- **Причина:** повышение дисциплины бронирования и снижение пропусков.
- **Решение:**
  - Добавлен планировщик APScheduler, который каждую минуту ищет брони на ближайшие 15 минут
  - Реализован сервис `booking_reminders.py`, который группирует брони по пользователю и отправляет одно письмо с таблицей ближайших работ (`send_booking_start_summary`)
  - Создана таблица `booking_reminders_sent` для предотвращения повторных напоминаний
  - Настроен SMTP (Яндекс) и логирование ошибок; добавлены проверки `ENABLE_EMAIL`
- **Статус:** выполнено, напоминания отправляются автоматически; при недоступности SMTP пользователю показывается предупреждение в логах.

## 2025-11-24 — Оптимизация запросов дашборда и индексация БД
- **Проблема:** вкладка «История бронирований» грузила всю историю с 10.10.2024, что увеличивало объём выборок и снижало отзывчивость; таблица `bookings` не имела индексов для частых фильтров.
- **Подпроект:** WSB_portal
- **Влияние:** пользователи дашборда, API `/api/dashboard/*`, БД RM
- **Причина:** отсутствие ограничений по периоду и индексов приводило к полным сканам таблиц при каждом запросе.
- **Решение:**
  - Ограничен стартовый диапазон дашборда последними 90 днями (по умолчанию), при этом пользователь может вручную расширить период.
  - Запросы дашборда теперь фильтруют данные на уровне SQL `WHERE date BETWEEN %s AND %s`, а не загружают полную таблицу.
  - Добавлен скрипт `scripts/create_indexes.py`, создающий индексы `idx_bookings_date_cancel`, `idx_bookings_date_equip`, `idx_bookings_user_date`, `idx_bookings_equip_time`.
- **Статус:** выполнено, основные запросы используют фильтры по датам и опираются на индексы; дальнейшая оптимизация (пагинация в модуле СИ, мониторинг) остаётся в планах.

## 2025-11-24 — Экспорт бронирований в CSV
- **Проблема:** пользователям и администраторам требовалось выгружать список бронирований для отчётов и согласований, приходилось копировать данные вручную.
- **Подпроект:** WSB_portal
- **Влияние:** вкладка «Управление бронированием», администраторы и обычные пользователи
- **Решение:**
  - Добавлен эндпоинт `GET /api/bookings/export`, формирующий CSV (UTF-8) за выбранную дату; админы получают все бронирования дня, остальные — только свои.
  - Создан сервис `export_bookings_csv` (форматирование, конвертация, кодировка с BOM).
  - Во вкладке «Управление бронированием» добавлена кнопка «Экспорт CSV», фронтенд скачивает файл без перезагрузки страницы.
- **Статус:** выполнено, экспорт доступен напрямую из UI.

## 2025-11-24 — Индексация БД equipment и оптимизация запросов модуля СИ
- **Проблема:** таблицы модуля СИ (СИ/ИО/ВО/Госреестр) тормозили при росте данных: запросы тянули все столбцы, а в БД equipment отсутствовали индексы по типам, серийным номерам и истории поверок.
- **Подпроект:** WSB_portal
- **Влияние:** вкладка «Система учета оборудования», БД equipment, API `/api/equipment/*`
- **Решение:**
  - скрипт `scripts/create_indexes.py` расширен — теперь он создаёт индексы как в БД RM (`bookings`), так и в БД `equipment` (тип+порядковый номер, тип+серийный номер, `equipment_types.type_name`, `gosregister.gosregister_number`, `calibration_certificates(equipment_id, certificate_date)`).
  - запросы `get_equipment_by_type` и `get_gosregister` отбирают только используемые в UI поля, что снижает нагрузку на сеть и сериализацию JSON.
- **Статус:** выполнено, таблицы СИ открываются быстрее, индексация запускается одной командой.

