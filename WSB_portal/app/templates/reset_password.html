<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Восстановление пароля</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <h1>Восстановление пароля</h1>
            <p class="auth-hint">Шаг 1. Запросите ссылку для восстановления</p>
            <form id="reset-request-form">
                <label for="reset-login">Телефон или e-mail</label>
                <input type="text" id="reset-login" required>
                <button type="submit" class="btn-secondary full-width">Получить ссылку</button>
                <p class="auth-error hidden" id="reset-request-error"></p>
                <p class="auth-hint" id="reset-request-result"></p>
            </form>
        </div>

        <div class="auth-card" style="margin-top: 16px;">
            <h1>Шаг 2. Установка нового пароля</h1>
            <form id="reset-confirm-form">
                <label for="reset-token">Токен</label>
                <input type="text" id="reset-token" value="{{ token or '' }}" required>

                <label for="reset-new-password">Новый пароль</label>
                <input type="password" id="reset-new-password" required minlength="8">

                <label for="reset-confirm-password">Подтверждение пароля</label>
                <input type="password" id="reset-confirm-password" required minlength="8">

                <button type="submit" class="btn-primary full-width">Сменить пароль</button>
                <p class="auth-error hidden" id="reset-confirm-error"></p>
                <p class="auth-hint hidden" id="reset-confirm-success"></p>
            </form>
            <a class="auth-back" href="/login">← Вернуться к входу</a>
        </div>
    </div>

    <script>
        const requestForm = document.getElementById("reset-request-form");
        const requestError = document.getElementById("reset-request-error");
        const requestResult = document.getElementById("reset-request-result");

        requestForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            requestError.textContent = "";
            requestError.classList.add("hidden");
            requestResult.textContent = "";

            const login = document.getElementById("reset-login").value.trim();
            if (!login) return;

            try {
                const response = await fetch("/auth/reset/request", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({login}),
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || "Не удалось отправить запрос.");
                }
                requestResult.textContent = `Токен: ${data.token}. Скопируйте его и вставьте в поле ниже. Срок действия до ${data.expires_at}.`;
            } catch (error) {
                requestError.textContent = error.message || "Ошибка запроса.";
                requestError.classList.remove("hidden");
            }
        });

        const confirmForm = document.getElementById("reset-confirm-form");
        const confirmError = document.getElementById("reset-confirm-error");
        const confirmSuccess = document.getElementById("reset-confirm-success");

        confirmForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            confirmError.textContent = "";
            confirmError.classList.add("hidden");
            confirmSuccess.textContent = "";
            confirmSuccess.classList.add("hidden");

            const token = document.getElementById("reset-token").value.trim();
            const newPassword = document.getElementById("reset-new-password").value;
            const confirmPassword = document.getElementById("reset-confirm-password").value;

            if (newPassword.length < 8) {
                confirmError.textContent = "Пароль должен быть не менее 8 символов.";
                confirmError.classList.remove("hidden");
                return;
            }
            if (newPassword !== confirmPassword) {
                confirmError.textContent = "Пароли не совпадают.";
                confirmError.classList.remove("hidden");
                return;
            }

            try {
                const response = await fetch("/auth/reset/confirm", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({token, new_password: newPassword}),
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || "Не удалось сменить пароль.");
                }
                confirmSuccess.textContent = data.message || "Пароль обновлён. Можно выполнить вход.";
                confirmSuccess.classList.remove("hidden");
            } catch (error) {
                confirmError.textContent = error.message || "Ошибка смены пароля.";
                confirmError.classList.remove("hidden");
            }
        });
    </script>
</body>
</html>

