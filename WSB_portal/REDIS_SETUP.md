# Настройка Redis для WSB Portal

## Описание

Redis используется для кэширования данных и ускорения работы портала. Кэшируются:
- Тепловые карты (TTL: 5 минут)
- Дашборд статистики (TTL: 10 минут)
- Списки оборудования и категорий (TTL: 30 минут)
- Данные модуля СИ (TTL: 15 минут)

## Установка Redis

### Windows (через Docker)

```bash
docker run -d --name redis-wsb -p 6379:6379 redis:7-alpine redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
```

### Linux

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install redis-server

# Настройка в /etc/redis/redis.conf
maxmemory 256mb
maxmemory-policy allkeys-lru
```

### macOS

```bash
brew install redis
brew services start redis
```

## Настройка переменных окружения

Добавьте в `.env` файл:

```env
# Redis настройки
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_ENABLED=true

# TTL для кэша (в секундах)
CACHE_TTL_HEATMAP=300      # 5 минут
CACHE_TTL_DASHBOARD=600    # 10 минут
CACHE_TTL_EQUIPMENT=1800   # 30 минут
CACHE_TTL_CATEGORIES=1800  # 30 минут
CACHE_TTL_SI_MODULE=900    # 15 минут
CACHE_TTL_USERS=1800       # 30 минут
```

## Проверка работы Redis

```bash
# Проверка подключения
redis-cli ping
# Должен вернуть: PONG

# Просмотр статистики
redis-cli info memory

# Просмотр всех ключей (осторожно!)
redis-cli keys "*"
```

## Мониторинг

### Размер кэша

```bash
redis-cli info memory | grep used_memory_human
```

### Количество ключей

```bash
redis-cli dbsize
```

### Очистка кэша (при необходимости)

```bash
# Очистить весь кэш
redis-cli FLUSHALL

# Очистить только текущую БД
redis-cli FLUSHDB
```

## Производительность

При правильной настройке Redis:
- Тепловые карты загружаются из кэша за ~1-5 мс (вместо 100-500 мс из БД)
- Дашборд загружается за ~5-10 мс (вместо 200-1000 мс из БД)
- Снижение нагрузки на PostgreSQL на 70-90%

## Автоматическая инвалидация кэша

Кэш автоматически очищается при:
- Создании нового бронирования → инвалидируется тепловая карта для этой даты
- Отмене бронирования → инвалидируется тепловая карта для этой даты
- Добавлении оборудования в модуль СИ → инвалидируется соответствующий раздел

## Рекомендации

1. **Размер памяти**: 256 MB достаточно для текущих объемов данных
2. **Политика удаления**: `allkeys-lru` - удаляет наименее используемые ключи при нехватке памяти
3. **Персистентность**: По умолчанию отключена (данные в памяти). Для продакшена можно включить RDB или AOF
4. **Мониторинг**: Регулярно проверяйте использование памяти и количество ключей

## Отключение кэширования

Если Redis недоступен, система автоматически работает без кэша (все запросы идут напрямую в БД). Для полного отключения:

```env
REDIS_ENABLED=false
```

