# Crystal Wafer Management System

Система управления складом кристаллов и пластин для ИПК ЭЛЕКТРОН-МАШ.

## Версия
**Текущая версия: 1.4.24**

## Описание проекта

Веб-приложение для управления складскими операциями с кристаллами и пластинами. Система поддерживает работу с несколькими типами складов:
- Склад кристаллов
- Склад пластин
- Дальний склад

## Основной функционал

### Управление складами
- Поиск кристаллов по различным критериям (доступен без авторизации)
- Загрузка данных о приходе товара (требуется авторизация)
- Загрузка данных о расходе товара (требуется авторизация)
- Загрузка данных о возврате товара (требуется авторизация)
- Инвентаризация с фильтрацией и экспортом (требуется авторизация)
- Корзина покупок с разделением по складам (доступна без авторизации)

### Телеграм-бот (интегрирован в веб-приложение)
Телеграм-бот встроен в основное Flask приложение и работает в едином процессе:
- Поиск остатков кристаллов по шифру через Telegram
- Поддержка всех трех складов (Склад кристаллов, Склад пластин, Дальний склад)
- Отображение остатков Wafer и GelPak для каждого склада
- Мобильный доступ к информации о складе без необходимости открывать веб-интерфейс
- Использует общий пул подключений к БД и систему логирования из веб-приложения
- Автоматический запуск при старте веб-приложения

### Технические особенности
- Динамический выбор таблиц БД в зависимости от типа склада
- Оптимизированная обработка больших файлов Excel
- Визуальная обратная связь при загрузке данных
- Экспорт данных в Excel с различными форматами
- Пул подключений к БД для оптимизации производительности
- Кэширование справочных данных
- Пагинация результатов поиска
- REST API для интеграций

## Технологии

- **Backend**: Python 3.14, Flask
- **Database**: PostgreSQL
- **Frontend**: HTML, CSS, JavaScript, Jinja2 templates
- **Data Processing**: Pandas, openpyxl
- **Testing**: pytest, pytest-cov, pytest-mock
- **Deployment**: Docker, Docker Compose

## Документация

- **[Руководство пользователя](USER_GUIDE.md)** - Подробное руководство для пользователей системы
- **[API Документация](web_app_WebChip/API_DOCUMENTATION.md)** - Документация REST API endpoints
- **[Документация по развертыванию](DEPLOYMENT.md)** - Инструкции по установке и развертыванию
- **[Итоговый отчет проекта](FINAL_PROJECT_REPORT.md)** - Полный отчет о состоянии проекта
- **[Отчет о комплексной проверке](PROJECT_CHECK_REPORT.md)** - Детальный отчет о проверке проекта и Docker конфигурации
- **[Инструкция по Docker](DOCKER_SETUP.md)** - Подробная инструкция по развертыванию с Docker
- **[История изменений](CHANGELOG.md)** - Подробная история версий и изменений
- **[Контекст проекта](PROJECT_CONTEXT.md)** - Общее описание проекта и его компонентов
- **[История решений](SOLUTIONS_HISTORY.md)** - История решенных проблем и их решений
- **[Отчет о проверке проекта](PROJECT_AUDIT_REPORT.md)** - Детальный отчет о проверке проекта

## Установка и запуск

### Требования
- Python 3.14+
- PostgreSQL
- Зависимости из `requirements.txt`

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка окружения
Создайте файл `.env` в корне проекта:
```
DB_HOST=192.168.1.139
DB_NAME=ElEngine
DB_USER=your_username
DB_PASSWORD=your_password
DB_PORT=5432
SECRET_KEY=your_secret_key_here
```

### Запуск приложения

**Режим разработки (development):**
```bash
cd web_app_WebChip
python app.py
```
Используется встроенный сервер Flask (только для разработки и тестирования).

**Production режим:**
1. Добавьте в `.env` файл:
```env
MODE=production
```

2. Запустите приложение:
```bash
cd web_app_WebChip
python app.py
```
Приложение автоматически запустится через Waitress WSGI сервер (production-ready).

**Развертывание с Docker:**
- См. [DOCKER_SETUP.md](DOCKER_SETUP.md) для подробных инструкций по Docker
- См. [DEPLOYMENT.md](DEPLOYMENT.md) для общего развертывания

**Объединенный контейнер:**
Проект поддерживает запуск веб-приложения и телеграм-бота в одном контейнере под управлением Supervisor:
```bash
docker-compose up -d crystal_wafer_combined
```

## Структура проекта

```
crystal_wafer/
├── web_app_WebChip/          # Основное веб-приложение
│   ├── app.py                # Главный файл приложения
│   ├── telegram_bot.py       # Телеграм-бот (интегрирован в приложение)
│   ├── logging_config.py     # Конфигурация логирования
│   ├── templates/            # HTML шаблоны
│   ├── static/               # Статические файлы (CSS, изображения)
│   ├── tests/                # Тесты приложения
│   ├── logs/                 # Логи приложения
│   ├── requirements.txt      # Зависимости Python
│   └── API_DOCUMENTATION.md  # Документация REST API
├── CHANGELOG.md              # История изменений
├── PROJECT_CONTEXT.md        # Контекст проекта
├── SOLUTIONS_HISTORY.md      # История решений проблем
├── USER_GUIDE.md             # Руководство пользователя
├── DEPLOYMENT.md             # Документация по развертыванию
├── PROJECT_AUDIT_REPORT.md   # Отчет о проверке проекта
├── FINAL_PROJECT_REPORT.md   # Итоговый отчет проекта
└── README.md                 # Этот файл
```

## История версий

См. [CHANGELOG.md](CHANGELOG.md) для подробной истории изменений.

### Версия 1.4.24 (2025-12-17)
- Исправлена логика инвентаризации для корректной обработки нулевых остатков
- Исправлено применение фильтров в SQL запросах инвентаризации
- Улучшено отображение сообщения "Нулевые остатки" с правильным размером шрифта
- Кнопки экспорта доступны даже при нулевых остатках

### Версия 1.4.23 (2025-12-17)
- Интеграция телеграм-бота в основное Flask приложение
- Телеграм-бот использует общий пул подключений к БД и систему логирования
- Улучшено форматирование вывода телеграм-бота с разделителями между складами и кристаллами
- Исправлены ошибки с инициализацией пула подключений и SQL запросами
- Docker deployment для объединенного приложения (веб + бот в одном контейнере)

### Версия 1.4.22 (2025-12-17)
- Создана полная документация (API, пользователя, развертывание)

### Версия 1.4.21 (2025-12-17)
- Расширенное логирование и мониторинг
- Структурированное логирование в JSON формате
- Файловое логирование с ротацией
- Middleware для логирования запросов с request_id

### Версия 1.4.20 (2025-12-17)
- Реализовано тестирование (pytest, 29 тестов)
- Покрытие тестами: 27%

### Версия 1.4.19 (2025-12-17)
- Реализована REST API структура (v1.0)
- Endpoints: search, chip-codes, manufacturers, lots, cart

### Версия 1.4.18 (2025-12-17)
- Оптимизация запросов (логирование медленных запросов, EXPLAIN ANALYZE)
- Оптимизированный COUNT запрос для пагинации

### Версия 1.4.17 (2025-12-17)
- Реализована пагинация результатов поиска
- Навигация по страницам с выбором количества результатов

### Версия 1.4.16 (2025-12-17)
- Созданы индексы БД для оптимизации запросов

### Версия 1.4.15 (2025-12-17)
- Реализовано кэширование справочных данных (TTL: 10 минут)

### Версия 1.4.14 (2025-12-17)
- Реализован пул подключений к БД (ThreadedConnectionPool)

### Версия 1.4.13 (2025-12-16)
- Исправлена работа корзины при изменении количества и удалении позиций
- Добавлен CSRF meta-тег в cart.html для корректной работы AJAX-запросов

### Версия 1.4.12 (2025-12-16)
- Добавлены модальные окна подтверждения для критичных действий

### Версия 1.4.11 (2025-12-16)
- Добавлены клавиатурные сокращения для всех основных страниц

### Версия 1.4.10 (2025-12-16)
- Исправлена критическая ошибка в функции поиска: фильтры теперь применяются корректно

### Версия 1.4.9 (2025-12-16)
- Исправлена проблема с накоплением flash-сообщений на странице логина
- Добавлено автоматическое скрытие flash-сообщений

### Версия 1.4.8 (2025-12-16)
- Добавлено автодополнение шифров кристаллов через HTML5 datalist
- Добавлены подсказки (tooltips) для всех полей ввода

## Безопасность

Система реализует следующие меры безопасности:
- Хеширование паролей (werkzeug.security)
- CSRF защита (Flask-WTF)
- SQL Injection защита (whitelist таблиц/столбцов, параметризованные запросы)
- XSS защита (escape HTML, валидация входных данных)
- Rate Limiting (Flask-Limiter)
- Защита от перечисления пользователей
- Audit Logging
- Безопасные настройки сессий

Подробнее см. [PROJECT_AUDIT_REPORT.md](PROJECT_AUDIT_REPORT.md).

## Производительность

Оптимизации производительности:
- Пул подключений к БД (ThreadedConnectionPool)
- Кэширование справочных данных (TTL: 10 минут)
- Индексы БД на часто используемых полях
- Пагинация результатов поиска
- Оптимизация запросов (логирование медленных запросов)

## REST API

Система предоставляет REST API версии 1.0 для интеграций:

- `GET /api/v1/search` - Поиск кристаллов
- `GET /api/v1/chip-codes` - Список шифров
- `GET /api/v1/manufacturers` - Список производителей
- `GET /api/v1/lots` - Список партий
- `GET /api/v1/cart` - Корзина пользователя
- `DELETE /api/v1/cart/<item_id>` - Удаление из корзины

Подробная документация: [web_app_WebChip/API_DOCUMENTATION.md](web_app_WebChip/API_DOCUMENTATION.md)

## Тестирование

Запуск тестов:
```bash
cd web_app_WebChip
pytest -v                    # Все тесты
pytest --cov=app --cov-report=html  # С покрытием кода
```

- Всего тестов: 29
- Все тесты проходят успешно (100%)
- Покрытие кода: 27%

Подробнее: [web_app_WebChip/tests/README.md](web_app_WebChip/tests/README.md)

## Статус проекта

**Готовность к production: ✅ ГОТОВО**

- ✅ Все критичные задачи безопасности выполнены (100%)
- ✅ Все важные задачи безопасности выполнены (100%)
- ✅ Производительность оптимизирована
- ✅ Документация полная
- ✅ Тесты написаны и работают
- ✅ REST API реализован и документирован

Подробный отчет: [FINAL_PROJECT_REPORT.md](FINAL_PROJECT_REPORT.md)

## Планы на будущее

### Не актуально (отложено)
- **Интернационализация (i18n):** Не требуется - все сотрудники русскоязычные
- **Мобильная версия:** Не требуется - используется Telegram бот (интегрирован в Docker контейнер)

### Низкий приоритет
- Резервное копирование данных (автоматическое)
- Двухфакторная аутентификация (2FA) для администраторов
- Увеличение покрытия тестами до 50-70%

## Автор

**Автор идеи и разработчик:** Полин Е.П.  
**Telegram:** @PolinEP  
**E-mail:** polin-ep@yandex.ru  

**Соразработчик:** Cursor  

**Лицензионные права:** ИнноЦентр ВАО и ИПК Электрон-Маш
