; ChipDip/supervisord.conf

[supervisord]
nodaemon=true                     ; Запуск supervisor в foreground (обязательно для Docker)
logfile=/var/log/supervisor/supervisord.log ; Путь к лог-файлу самого supervisord
pidfile=/var/run/supervisord.pid  ; Путь к pid-файлу

[program:webapp]
command=/usr/local/bin/gunicorn --workers 1 --threads 4 --timeout 120 --bind 0.0.0.0:8085 "webapp:create_app()"
; Если ваше Flask-приложение (объект app) находится в run_webapp.py:
; command=/usr/local/bin/gunicorn --workers 1 --threads 4 --timeout 120 --bind 0.0.0.0:8085 run_webapp:app
directory=/app
autostart=true
autorestart=true
stopwaitsecs=10                   ; Время ожидания перед принудительным завершением (SIGKILL)
stopsignal=TERM                   ; Сигнал для остановки процесса
user=root                         ; Пользователь, от имени которого запускается процесс (если не указан, то root)
environment=PYTHONUNBUFFERED=1    ; Для корректного вывода логов Python
stdout_logfile=/var/log/supervisor/webapp_stdout.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3
stderr_logfile=/var/log/supervisor/webapp_stderr.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=3

[program:parser]
command=/usr/local/bin/python -m chipdip_parser.app
directory=/app
autostart=true
autorestart=true                  ; Перезапускать, если упал
startsecs=5                       ; Время, которое процесс должен проработать, чтобы считаться успешно запущенным
stopwaitsecs=70                   ; Даем парсеру больше времени на корректное завершение (учитывая его задержки)
stopsignal=TERM
user=root
environment=PYTHONUNBUFFERED=1
stdout_logfile=/var/log/supervisor/parser_stdout.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3
stderr_logfile=/var/log/supervisor/parser_stderr.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=3