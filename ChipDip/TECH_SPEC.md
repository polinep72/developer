# Техническое задание (ТЗ) — ChipDip Парсер и Веб‑аналитика

## 1. Назначение системы
Система парсинга ассортимента и цен с ChipDip с последующим хранением в PostgreSQL, предоставлением веб‑интерфейса для аналитики и выгрузок (Excel/PowerPoint). Поддержка многопользовательского режима и редактирования названий товаров в ЛК.

## 2. Объем работ и границы
- Парсер: сбор остатков и цен по списку товаров на расписании.
- БД: хранение справочника товаров и истории измерений (`stock_history`).
- Веб: 7 интерактивных графиков (Plotly), экспорт таблиц и графиков в Excel/PPTX.
- API: REST для данных графиков и экспортов.
- Мониторинг: health‑эндпоинты.

## 3. Роли и доступ
- Гость: просмотр всех графиков и экспортов; редактирование запрещено.
- Пользователь: управление своими товарами, inline-редактирование названий, просмотр аналитики.
- После авторизации все графики/экспорты фильтруются по товарам пользователя; без авторизации отображаются данные по всем товарам.
- Администратор: операционные действия через Docker.

## 4. Функциональные требования
- Импорт/добавление товаров (URL, `internal_sku`, название).
- Регулярный сбор: сохранение `stock_level`, `price`, `check_timestamp`.
- Аналитика:
  - Топ‑20 продаж.
  - Продажи по месяцам (все товары; 12 месяцев; stacked bar).
  - Выручка по месяцам (все товары; stacked bar).
  - Остатки товара (line).
  - Стоимость товара (line).
  - Продажи по месяцам (товар; line).
  - Выручка по месяцам (товар; bar).
- Экспорт: для каждого графика отдельная кнопка Excel; PowerPoint для месячных продаж.
- Inline‑редактирование названия товара в ЛК владельцем.

## 5. Нефункциональные требования
- Контейнеризация Docker, запуск через `docker-compose`.
- Совместимость с PostgreSQL 13+.
- Время ответа API: < 2 с при 50k строк истории.
- Надежность: автоматическое восстановление соединения парсера с БД.
- Локализация: русскоязычный UI.

## 6. Архитектура (высокоуровнево)
- Сервисы: `webapp` (Flask + Plotly), `parser` (Python), `postgres`.
- Коммуникация: `webapp` <-> PostgreSQL; `parser` <-> PostgreSQL.
- Статика: шаблоны Jinja2; графики отрисовываются на клиенте.

## 7. Модель данных (основные таблицы)
- `products(id, user_id, name, internal_sku, url, is_active, current_price, last_checked_at, created_at, updated_at)`
- `stock_history(id, product_id, check_timestamp, stock_level, price, raw_text, status, error_message)`
- `users(id, username, password_hash, is_active, created_at, updated_at)`

Индексы: `stock_history(product_id, check_timestamp)`; внешние ключи на `products(id)`.

## 8. API (ключевые)
- Публичные данные графиков выручки:
  - `GET /api/stats/revenue/monthly`
  - `GET /api/stats/revenue/product-monthly?product_id=...`
- Публичные экспорты:
  - `GET /api/export/chart/revenue/excel`
  - `GET /api/export/chart/product-revenue/excel?product_id=...`
- Остальные API для графиков и экспорта — см. README.md (полный список).
- Мониторинг: `GET /health`, `GET /api/health`, `GET /healthz` (JSON `{status, db}`).

## 9. UI/UX
- Графики интерактивные, легенда с возможностью скрытия серий.
- Отдельные кнопки экспорта над каждым графиком.
- Inline‑редактирование через клик по названию в `my_products.html`.

## 10. Правила сортировки и соответствие типов графиков
- Экспорт в Excel повторяет типы графиков страницы.
- Даты в экспортируемых графиках — по возрастанию.
- Оси подписаны во всех экспортируемых графиках.

## 11. Безопасность
- Редактирование товара разрешено только владельцу (проверка `user_id`).
- Публичный доступ только к чтению данных и экспортам.

## 12. Мониторинг/Диагностика
- Health: `/health`, `/api/health`, `/healthz`.
- Логи webapp: `docker-compose logs -f --tail=200 webapp` (в PowerShell без `&&`).

## 13. Развертывание
- Docker Compose, см. INSTALLATION.md.

## 14. Критерии приемки
- Все 7 графиков отображаются у гостя.
- Экспорт для каждого графика создает корректный файл с нужным типом диаграммы, возрастанием дат и подписями осей.
- Health возвращает 200 OK и `db:true` при доступной БД.
