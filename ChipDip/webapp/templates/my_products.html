{% extends "base.html" %}

{% block title %}Мои товары - ChipDip Парсер{% endblock %}

{% block content %}
<div class="my-products">
    <h2>Мои товары</h2>
    <p class="info-text">Здесь отображаются только товары, которые вы добавили лично.</p>
    
    <div class="actions">
        <a href="{{ url_for('main.add_product') }}" class="btn btn-primary">Добавить новый товар</a>
        <form method="get" action="{{ url_for('main.my_products') }}" style="display:inline-block; margin-left: 12px;">
            <input type="text" name="q" placeholder="Поиск по названию" value="{{ q or '' }}" />
            <button type="submit" class="btn btn-primary">Поиск</button>
            {% if q %}
            <a href="{{ url_for('main.my_products') }}" class="btn btn-small">Сброс</a>
            {% endif %}
        </form>
    </div>
    
    {% if products %}
        <table>
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Артикул</th>
                    <th>URL</th>
                    <th>Текущая цена</th>
                    <th>Остаток</th>
                    <th>Последняя проверка</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr {% if not product.is_active %}style="opacity: 0.6; background-color: #f8f9fa;"{% endif %}>
                    <td>
                        <span class="product-name" data-product-id="{{ product.id }}" data-current-name="{{ product.name }}" style="cursor: pointer; border-bottom: 1px dashed #007bff;" title="Кликните для редактирования">
                            {{ product.name }}
                        </span>
                    </td>
                    <td>{{ product.internal_sku }}</td>
                    <td><a href="{{ product.url }}" target="_blank">{{ product.url[:50] }}...</a></td>
                    <td>
                        {% if product.current_price %}
                            {{ "%.2f"|format(product.current_price) }} ₽
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if product.latest_stock is not none %}
                            {{ product.latest_stock }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if product.last_checked_at %}
                            {{ product.last_checked_at.strftime('%d.%m.%Y %H:%M') }}
                        {% else %}
                            Не проверялся
                        {% endif %}
                    </td>
                    <td>
                        {% if product.is_active %}
                            <span style="color: green;">Активен</span>
                        {% else %}
                            <span style="color: red;">Удален</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('main.product_history', product_id=product.id) }}" class="btn btn-small">История</a>
                        {% if product.is_active %}
                            <form method="POST" action="{{ url_for('main.delete_product', product_id=product.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Вы уверены, что хотите удалить этот товар?')">Удалить</button>
                            </form>
                        {% else %}
                            <form method="POST" action="{{ url_for('main.restore_product', product_id=product.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-small btn-success">Восстановить</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>У вас пока нет добавленных товаров. <a href="{{ url_for('main.add_product') }}">Добавить первый товар</a></p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик клика по названию товара
    document.querySelectorAll('.product-name').forEach(function(element) {
        element.addEventListener('click', function() {
            if (this.querySelector('input')) return; // Уже в режиме редактирования
            
            const productId = this.dataset.productId;
            const currentName = this.dataset.currentName;
            
            // Создаем input для редактирования
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.style.width = '100%';
            input.style.padding = '4px';
            input.style.border = '1px solid #007bff';
            input.style.borderRadius = '3px';
            
            // Заменяем содержимое на input
            const originalContent = this.innerHTML;
            this.innerHTML = '';
            this.appendChild(input);
            input.focus();
            input.select();
            
            // Обработчики для сохранения/отмены
            const saveEdit = function() {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    // Отправляем запрос на сервер
                    fetch(`/api/product/${productId}/name`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({name: newName})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Обновляем отображаемое название
                            element.innerHTML = newName;
                            element.dataset.currentName = newName;
                            element.style.color = '#28a745';
                            setTimeout(() => {
                                element.style.color = '';
                            }, 2000);
                        } else {
                            // Показываем ошибку и возвращаем исходное название
                            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                            element.innerHTML = originalContent;
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        alert('Ошибка при обновлении названия');
                        element.innerHTML = originalContent;
                    });
                } else {
                    // Отменяем редактирование
                    element.innerHTML = originalContent;
                }
            };
            
            const cancelEdit = function() {
                element.innerHTML = originalContent;
            };
            
            // Сохранение по Enter
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
            
            // Сохранение при потере фокуса
            input.addEventListener('blur', function() {
                setTimeout(saveEdit, 100); // Небольшая задержка для обработки клика
            });
        });
    });
});
</script>
{% endblock %}
