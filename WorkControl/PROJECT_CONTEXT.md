# PROJECT_CONTEXT.md

## Описание проекта

**WorkControl** — система автоматического мониторинга состояния различных сервисов с отправкой уведомлений в Telegram и интерактивным управлением через бота.

## Структура проекта

```
WorkControl/
├── main.py              # Основной модуль мониторинга
├── requirements.txt     # Python зависимости
├── Dockerfile          # Конфигурация Docker образа
├── docker-compose.yml  # Docker Compose конфигурация
├── .env                # Переменные окружения (не в репозитории)
├── .dockerignore       # Исключения для Docker build
├── .cursorrules        # Правила работы с проектом
├── README.md           # Документация проекта
├── PROJECT_CONTEXT.md  # Контекст проекта (этот файл)
├── SOLUTIONS_HISTORY.md # История решений
├── CHAT_HISTORY.md     # История переписки
├── SYNC_INSTRUCTIONS.md # Инструкции по синхронизации
└── CHANGELOG.md        # История изменений
```

## Архитектура

### Компоненты системы

1. **Мониторинг сервисов**
   - Проверка Docker-контейнеров (статус, health)
   - Проверка HTTP endpoints (доступность, статус-коды)
   - Автоматические уведомления о проблемах и восстановлении

2. **База данных PostgreSQL**
   - Таблица `monitoring_services` — конфигурация сервисов
   - Таблица `service_checks` — история проверок
   - Таблица `new_records` — новые записи для мониторинга

3. **Telegram-бот**
   - Интерактивное управление через команды и кнопки
   - Команды: `/start`, `/status`, `/check`, `/restart`, `/reload`, `/db`, `/help`
   - Перезапуск Docker-контейнеров через бота

4. **Расписание**
   - Ежечасные проверки (по умолчанию в :05 каждой часа)
   - Ежедневные отчеты (по умолчанию в 07:30)
   - Проверка новых записей в БД (каждые 12 часов)

### Технологический стек

- **Python 3.9+**
- **Docker** + **Docker Compose**
- **PostgreSQL** — хранение конфигурации и истории
- **python-telegram-bot** — Telegram Bot API
- **psycopg2** — подключение к PostgreSQL
- **docker** (Python client) — управление контейнерами
- **requests** — HTTP проверки
- **schedule** — планирование задач

## Текущий статус

### Версия: 1.0.0

**Реализовано:**
- ✅ Мониторинг Docker-контейнеров
- ✅ Мониторинг HTTP endpoints
- ✅ Автоматические уведомления в Telegram
- ✅ Хранение конфигурации в PostgreSQL
- ✅ Telegram-бот с интерактивным управлением
- ✅ Перезапуск контейнеров через бота
- ✅ Ежечасные проверки и ежедневные отчеты
- ✅ Автоматический перезапуск контейнеров (опционально)

**Мониторируемые сервисы:**
- 4 Docker-контейнера (боты)
- 8 WEB-сервисов (HTTP endpoints)

**Всего сервисов:** 12

## Конфигурация

### Переменные окружения (.env)

**Обязательные:**
- `TELEGRAM_BOT_TOKEN` — токен Telegram бота
- `TELEGRAM_CHAT_ID` — ID чата для уведомлений

**Опциональные:**
- `TELEGRAM_BOT_ENABLED` — включить/выключить бота (true/false)
- `HTTP_TIMEOUT` — таймаут HTTP запросов (сек)
- `REPORT_TIME` — время ежедневного отчета (HH:MM)
- `CHECK_INTERVAL_HOURLY_AT` — минута для ежечасных проверок (:MM)
- `AUTO_RESTART_CONTAINERS` — автоперезапуск контейнеров (true/false)
- `AUTO_RESTART_ALLOW_LIST` — список сервисов для автоперезапуска (через запятую)
- `DB_ENABLED` — включить/выключить БД (true/false)
- `DB_USER`, `DB_PASSWORD`, `DB_HOST`, `DB_PORT`, `DB_NAME` — параметры подключения к БД
- `LOG_LEVEL` — уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)

### База данных

**Таблица `monitoring_services`:**
- `id` — первичный ключ
- `name` — название сервиса (уникальное)
- `type` — тип проверки ('http' | 'docker_container_status')
- `check_params` — параметры проверки (JSONB)
- `enabled` — включен/выключен
- `priority` — приоритет сортировки
- `created_at` — дата создания

**Таблица `service_checks`:**
- `id` — первичный ключ
- `service_name` — название сервиса
- `status` — статус проверки (OK, FAIL, UNKNOWN)
- `message` — детали проверки
- `checked_at` — время проверки
- `created_at` — дата создания записи

**Таблица `new_records`:**
- `id` — первичный ключ
- `table_name` — название таблицы
- `record_id` — ID записи
- `data` — данные записи (JSONB)
- `detected_at` — время обнаружения
- `processed` — обработана ли запись

## Зависимости

См. `requirements.txt`:
- requests
- schedule
- docker
- python-dotenv
- python-telegram-bot
- psycopg2-binary

## Развертывание

1. Создать `.env` с необходимыми переменными
2. Собрать и запустить: `docker compose up -d --build monitor`
3. Проверить логи: `docker logs -f my-monitor`

## Связи с другими проектами

- **PostgreSQL** — внешняя БД для хранения конфигурации
- **Docker** — мониторинг контейнеров на том же хосте
- **Telegram** — уведомления и интерактивное управление

## Примечания

- Все сервисы настраиваются через БД, не через код
- Пересборка контейнера не требуется при изменении конфигурации сервисов
- Используется `network_mode: "host"` для доступа к Docker socket и локальным сервисам

