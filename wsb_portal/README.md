# WSB Portal

Веб-портал бронирования рабочих мест по адресу `http://192.168.1.139:8090`. Цель — предоставить те же сценарии, что и у Telegram-бота WSB, но через веб-интерфейс, повторно используя проверенную бизнес-логику и подключения к БД.

## Назначение
- Бронирование рабочих мест и оборудования через браузер
- Управление заявками и расписанием администраторами
- Повторное использование модулей `services` и `database` из существующих WSB решений
- Подготовка к дальнейшей интеграции с heatmap и аналитикой

## Стек
- Python 3.11+
- FastAPI + Jinja2
- Plotly для визуализации тепловой карты
- PostgreSQL (боевая БД `RM`, демо-режим при отсутствии параметров)
- Redis/WebSocket (планируемые уведомления)

## Текущий статус
- ✅ Реализованы 6 основных вкладок:
  - **Бронирование оборудования** — форма бронирования с тепловой картой занятости. Интервал времени: 7:00-22:00 (шаг 30 минут)
  - **Управление бронированием** — просмотр и отмена бронирований (раздельный доступ для пользователей и администраторов). **Доступна только авторизованным пользователям**
  - **История бронирований (статистика и графики)** — система подвкладок: Даш-борд (настраиваемые виджеты), Тепловая карта, Статистика по оборудованию (расширенная аналитика), Статистика по пользователям (расширенная аналитика), Временные паттерны, Прогноз загрузки, Рекомендации. Все данные за последние 6 месяцев
  - **Календарь бронирований** — месячное представление бронирований с возможностью перехода к деталям. **Доступна только авторизованным пользователям**
  - **Система учета оборудования (СИ)** — полная интеграция модуля СИ с 4 подвкладками (СИ, ИО, ВО, Госреестр)
  - **Управление пользователями** — создание, редактирование, удаление пользователей и сброс паролей (только для администраторов)
- ✅ **Контроль доступа:** для неавторизованных пользователей доступны только 3 вкладки (Бронирование оборудования, История бронирований, Система учета оборудования)
- ✅ Система авторизации пользователей (JWT, вход по телефону/email, смена и восстановление пароля через корпоративный email)
- ✅ Расширенная аналитика:
  - Детальная статистика по оборудованию (количество бронирований, средняя длительность, процент загрузки, топ пользователей)
  - Детальная статистика по пользователям (количество бронирований, часто используемое оборудование, распределение по дням недели, пиковые часы)
  - Графики распределения по дням недели, пиковым часам, динамики по месяцам
  - Рекомендации по расширению парка оборудования на основе пиковых инцидентов
- ✅ Дашборд и тепловые карты строятся непосредственно в портале без внешних iframe, поддерживают адаптивное масштабирование
- ✅ Обновлена шапка портала с официальным логотипом ИПК «Электрон-Маш»
- ✅ Светлоголубая сетка на тепловых картах для визуального разделения интервалов
- ✅ Автоматическая остановка предыдущих экземпляров сервера при запуске

## Структура проекта
```
WSB_portal/
├── app/
│   ├── main.py                 # FastAPI, маршруты и API-эндпоинты
│   ├── templates/
│   │   ├── index.html          # Главная страница с 6 вкладками
│   │   ├── register.html        # Страница регистрации
│   │   ├── login.html          # Страница входа
│   │   └── reset_password.html  # Страница восстановления пароля
│   ├── static/
│   │   ├── css/main.css        # Стили портала
│   │   ├── js/main.js          # JavaScript логика вкладок и API
│   │   └── img/logo.webp       # Логотип ИПК «Электрон-Маш»
│   └── services/
│       ├── heatmap.py          # Подключение к БД RM, Plotly тепловая карта
│       ├── dashboard.py        # Агрегация статистики бронирований, графики и таблицы
│       ├── bookings.py         # Логика бронирования (категории, оборудование, слоты, создание/отмена)
│       ├── equipment.py        # Работа с БД equipment (СИ, ИО, ВО, Госреестр)
│       ├── auth.py             # Авторизация пользователей (JWT, пароли)
│       └── notifications.py    # Отправка email-уведомлений о бронированиях
├── scripts/
│   ├── set_temp_passwords.py   # Установка временных паролей для существующих пользователей
│   ├── create_reset_table.py  # Создание таблицы для восстановления паролей
│   ├── create_notification_settings_table.py  # Создание таблицы настроек уведомлений
│   ├── create_indexes.py      # Создание индексов в БД для оптимизации
│   └── check_user.py           # Утилита проверки пользователей
├── requirements.txt            # Зависимости портала
├── Dockerfile                  # Docker образ приложения
├── docker-compose.yml          # Docker Compose конфигурация
├── .dockerignore               # Исключения для Docker
├── README.md                   # Этот файл
├── PROJECT_CONTEXT.md          # Контекст проекта
├── PROJECT_AUDIT_FULL.md      # Полный аудит проекта
├── DOCKER_CHECK.md             # Проверка готовности к Docker
├── DOCKER_SETUP.md             # Инструкции по Docker
├── SOLUTIONS_HISTORY.md        # История решений
├── CHAT_HISTORY.md             # История переписки
├── SYNC_INSTRUCTIONS.md        # Инструкции по синхронизации
├── CHANGELOG.md                # История изменений
├── REDIS_SETUP.md              # Настройка Redis
├── NOTIFICATIONS_SETUP.md      # Настройка уведомлений
└── .cursorrules                # Правила проекта
```

## Конфигурация окружения
Создайте файл `.env` в корне `WSB_portal` или задайте переменные окружения:

### База данных RM (для бронирования, статистики и календаря)
```
POSTGRE_HOST=192.168.1.139
POSTGRE_PORT=5432
POSTGRE_USER=postgres
POSTGRE_PASSWORD=**********
POSTGRE_DBNAME=RM
```

### База данных equipment (для системы учета оборудования)
```
EQUIPMENT_DB_NAME=equipment
EQUIPMENT_DB_HOST=192.168.1.139
EQUIPMENT_DB_PORT=5432
EQUIPMENT_DB_USER=postgres
EQUIPMENT_DB_PASSWORD=************
```

### Настройки SMTP для уведомлений (опционально)
```
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=587
SMTP_USER=your_email@yandex.ru
SMTP_PASSWORD=your_smtp_password
SMTP_FROM_EMAIL=your_email@yandex.ru
SMTP_FROM_NAME=WSB Portal
ENABLE_EMAIL=true
```

### JWT и авторизация
```
AUTH_SECRET_KEY=your_secret_key_here_min_32_chars
AUTH_ALGORITHM=HS256
AUTH_ACCESS_MINUTES=720
AUTH_RESET_MINUTES=60
```

### Redis (для кеширования)
```
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_ENABLED=true
```

### Публичный URL портала (для ссылок в email)
```
PORTAL_PUBLIC_URL=http://192.168.1.139:8090
```

**Примечания:** 
- Для Gmail необходимо использовать "Пароль приложения" вместо обычного пароля
- Если `ENABLE_EMAIL=false` или настройки SMTP не указаны, уведомления будут логироваться в консоль, но не отправляться
- Для создания таблицы настроек уведомлений выполните: `python scripts/create_notification_settings_table.py`
- Для оптимизации БД выполните: `python scripts/create_indexes.py`
- Полный список переменных окружения см. в `.env.example` (если создан) или `DOCKER_SETUP.md`

**Примечание:** Если `EQUIPMENT_DB_HOST`, `EQUIPMENT_DB_USER`, `EQUIPMENT_DB_PASSWORD` не указаны, будут использоваться значения из `DB_HOST`, `DB_USER`, `DB_PASSWORD` (или `POSTGRE_*`). Но `EQUIPMENT_DB_NAME` должен быть строго указан как `equipment`, так как `DB_NAME`/`POSTGRE_DBNAME` содержит `RM`.

Портал также понимает переменные с префиксом `DB_` (например, `DB_HOST`). Для удобства можно вести `.env` с вышеуказанными параметрами.

## Деплой с Docker (рекомендуется)

### Быстрый старт

```bash
# Запуск всех сервисов (app + Redis)
docker-compose up -d --build

# Просмотр логов
docker-compose logs -f

# Остановка
docker-compose down
```

**Подробная инструкция:** см. `DOCKER_SETUP.md`.

### Требования

- Docker версии 20.10+
- Docker Compose версии 2.0+
- Файл `.env` с настройками (см. раздел "Конфигурация окружения")

## Ближайшие задачи
- ✅ Подготовить Docker-сборку и сценарии деплоя
- ✅ Реализовать расширенную аналитику для статистики по оборудованию и пользователям
- ✅ Расширить интервал времени бронирования (7:00-22:00)
- ✅ Добавить календарь бронирований
- ✅ Провести полный аудит проекта (безопасность, UX, фичи)
- Интегрировать с Telegram-ботом для bidirectional синхронизации
- Реализовать CSRF защиту (критично для безопасности)
- Добавить фильтры и поиск в модуле СИ, а также расширенные отчёты
- Реализовать повторяющиеся бронирования
- Добавить уведомления в реальном времени (WebSocket)

**Подробный список задач и рекомендаций:** см. `PROJECT_AUDIT_FULL.md`

## Локальный запуск (режим Cursor)
```bash
cd C:\Soft_IPK\WSB_portal
python -m venv .venv && .\.venv\Scripts\activate
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8090
```

Если переменные `DB_*` или `POSTGRE_*` не заданы, портал автоматически покажет демо-данные тепловых карт и дашборда. Для подключения к боевым БД:
- **RM** (вкладки 1-2): заполните `POSTGRE_DBNAME=RM` или `DB_NAME=RM`
- **equipment** (вкладка 3): заполните `EQUIPMENT_DB_NAME=equipment`

**Для работы уведомлений:**
1. Настройте SMTP в `.env` (см. `NOTIFICATIONS_SETUP.md`)
2. Выполните: `python scripts/create_notification_settings_table.py`

После настройки `.env` перезапустите сервер.

## Деплой и мониторинг (кратко)
- **Продакшен:** создайте `.env`, установите зависимости в venv и запустите `uvicorn app.main:app --host 0.0.0.0 --port 8090` (systemd unit пример — в `SYNC_INSTRUCTIONS.md`). Для Windows используйте Task Scheduler + PowerShell-скрипт активации окружения.
- **Redis/SMTP:** перед запуском обязательно подтвердите доступность Redis (`redis-cli ping`) и SMTP (принятие EULA, корректные креды).
- **Мониторинг:** просматривайте `uvicorn.log`/journald, проверяйте логи APScheduler (`Задача отправки напоминаний выполнена...`). При ошибках SMTP (`[EMAIL ERROR]`) проверьте настройки.
- **Health-check:** можно раз в 5 минут обращаться к `/auth/me` сервисным токеном или использовать `scripts/check_user.py`.
- **Резервное копирование:** выполняйте `pg_dump` БД `RM` и `equipment` ежедневно до внедрения автоматизации.
- Полные инструкции по деплою/мониторингу — в `SYNC_INSTRUCTIONS.md`.

## API

### Авторизация
- `POST /auth/login` — вход пользователя (телефон/email + пароль)
- `POST /auth/register` — регистрация нового пользователя (требуется Telegram ID)
- `POST /auth/logout` — выход пользователя
- `GET /auth/me` — информация о текущем пользователе
- `POST /auth/change-password` — смена пароля (требуется авторизация)
- `POST /auth/reset/request` — запрос на восстановление пароля (отправка email с токеном)
- `POST /auth/reset/confirm` — подтверждение восстановления пароля по токену
- `GET /reset-password?token=...` — страница восстановления пароля по токену

### Управление пользователями (только для админов)
- `GET /api/users` — список всех пользователей
- `GET /api/users/{user_id}` — информация о пользователе
- `POST /api/users` — создание нового пользователя
- `PUT /api/users/{user_id}` — обновление данных пользователя
- `POST /api/users/{user_id}/reset-password` — сброс пароля пользователя
- `DELETE /api/users/{user_id}` — удаление пользователя

### Бронирование и статистика (БД RM)
- `GET /api/heatmap?selected_date=YYYY-MM-DD` — данные для основной тепловой карты
- `GET /api/bookings/categories` — список категорий оборудования
- `GET /api/bookings/equipment?category_id=...` — оборудование по категории
- `GET /api/bookings/slots?equipment_id=...&date=...` — доступные временные слоты (7:00-22:00)
- `POST /api/bookings` — создание нового бронирования (требуется авторизация)
- `GET /api/bookings/my?selected_date=...` — мои бронирования (требуется авторизация)
- `GET /api/bookings/all?selected_date=...` — все бронирования (требуется админ)
- `POST /api/bookings/{booking_id}/cancel` — отмена бронирования (требуется авторизация)
- `GET /api/bookings/calendar?year=...&month=...` — данные календаря бронирований (требуется авторизация)
- `GET /api/dashboard/init` — список оборудования, диапазон дат и стартовые данные дашборда
- `POST /api/dashboard/data` — сформировать графики/таблицы по выбранным фильтрам (включая расширенную аналитику)

### Система учета оборудования (БД equipment)
- `GET /api/equipment/types` — список типов оборудования
- `GET /api/equipment/stats` — статистика по оборудованию
- `GET /api/equipment/gosregister` — данные Госреестра средств измерений
- `GET /api/equipment/{equipment_type}` — оборудование по типу (СИ, ИО, ВО)
- `GET /api/equipment/certificates/{equipment_id}` — история поверок/аттестаций
- `POST /api/equipment/add-si` — добавление средства измерения
- `POST /api/equipment/add-io` — добавление испытательного оборудования
- `POST /api/equipment/add-vo` — добавление вспомогательного оборудования
- `POST /api/equipment/add-gosregister` — добавление записи в Госреестр
