# История решений — WSB_core

## 2025-12-04 — Расширение моделей бронирования в wsb_core.models
- **Проблема:** Модели бронирования в `wsb_core.models` не соответствуют реальной структуре БД и не поддерживают все необходимые поля и статусы.
- **Подпроект:** WSB_core
- **Влияние:** Единообразие представления данных бронирования между ботом и порталом.
- **Причина:** Необходимость унификации моделей для корректной работы с данными из БД.
- **Решение:** 
  - Расширен `BookingStatus` добавлением статуса `PLANNED` (запланировано)
  - Расширена модель `Booking` для соответствия структуре БД:
    - Добавлены поля: `cancel`, `finish`, `time_interval`, `duration`, `data_booking`
    - Добавлены поля из JOIN: `user_fio`, `equipment_name`
    - Добавлено поле `date` для соответствия структуре БД
  - Добавлена функция `determine_booking_status()` для определения статуса брони на основе полей БД
  - Добавлена функция `booking_from_db_row()` для создания объекта Booking из строки БД с поддержкой разных вариантов именования полей (equip_id/equipment_id, user_fi/fio, name_equip/equipment_name)
  - Расширена модель `User` добавлением полей `email` и `is_active`
- **Статус:** выполнено. Модели расширены и соответствуют структуре БД.

## 2025-12-04 — Общий модуль логики бронирований (wsb_core/bookings_core)
- **Проблема:** Логика создания и отмены бронирований дублируется в портале и боте.
- **Подпроект:** WSB_core
- **Влияние:** Единая бизнес-логика, синхронизация с `wsb_time_slots`, упрощение сопровождения.
- **Причина:** Требуется централизовать проверки рабочего времени, длительности, конфликтов и обновление таблиц при бронированиях.
- **Решение:**
  - Создан `wsb_core/bookings_core.py` с функциями `create_booking_core` и `cancel_booking_core`
  - Добавлены проверки пользователя, рабочего времени, конфликтов, вставка/отмена с возвратом `Booking`
  - Реализована синхронизация с `wsb_time_slots` и использование `wsb_core.models`
  - `WSB_portal/app/services/bookings.py` переведён на использование ядра (кеши/уведомления остались на уровне портала)
- **Статус:** выполнено. Портал использует ядро для операций бронирования; следующий шаг — подключение Telegram-бота.

## 2025-12-04 — Унификация логики генерации слотов через wsb_core.slots
- **Проблема:** Логика расчета доступных слотов дублируется в боте и портале, что может привести к расхождениям.
- **Подпроект:** WSB_core
- **Влияние:** Единообразие логики расчета слотов между ботом и порталом.
- **Причина:** Необходимость унификации логики генерации слотов для обеспечения согласованности работы всей системы.
- **Решение:** 
  - Расширен `wsb_core/slots.py` функцией `calculate_available_slots_from_bookings()` для унифицированного расчета слотов на основе списка бронирований
  - Адаптирован `wsb_bot/services/booking_service.py` для использования `wsb_core.slots.calculate_available_slots_from_bookings()` вместо локальной реализации
  - Сохранена локальная реализация как fallback (`_calculate_available_slots_local()`) на случай недоступности `wsb_core`
  - Портал уже использует `wsb_core.slots` для работы с таблицей `wsb_time_slots`
- **Статус:** выполнено. Логика генерации слотов унифицирована, бот и портал используют общее ядро.

## 2025-12-04 — Унификация констант через wsb_core
- **Проблема:** Константы времени работы и шага бронирования различаются между ботом (8:00-20:00) и порталом (7:00-22:00), что может привести к несоответствиям.
- **Подпроект:** WSB_core
- **Влияние:** Единообразие логики бронирований между ботом и порталом.
- **Причина:** Необходимость унификации констант для обеспечения согласованности работы всей системы.
- **Решение:** 
  - Обновлен `wsb_core/constants.py` с унифицированными константами: 7:00-22:00, шаг 30 минут, максимальная длительность 8 часов
  - Адаптирован `wsb_bot/constants.py` для использования констант из `wsb_core.constants` с fallback на локальные значения
  - Адаптирован `wsb_bot/services/booking_service.py` для использования констант из `wsb_core.constants`
  - Обновлен `wsb_portal/app/services/bookings.py` для использования констант из `wsb_core.constants`
  - Добавлена логика добавления корня проекта в PYTHONPATH для корректного импорта `wsb_core`
- **Статус:** выполнено. Константы унифицированы, оба проекта используют значения из `wsb_core.constants`.

## 2025-12-04 — Копирование боевых версий в WSB_core
- **Проблема:** Необходимо работать над объединением бота и портала, не затрагивая боевые версии `WSB/` и `WSB_portal/`.
- **Подпроект:** WSB_core
- **Влияние:** Безопасность боевых систем, возможность разработки без риска для продакшена.
- **Причина:** Боевые версии зафиксированы (WSB_portal v0.3.8, WSB бот v5.1.0), все изменения должны происходить только в `WSB_core/`.
- **Решение:** 
  - Скопированы все файлы из `WSB/` (Telegram бот) в `WSB_core/wsb_bot/`:
    - handlers/ (обработчики команд и callback'ов)
    - services/ (бизнес-логика: booking_service, equipment_service, notification_service и др.)
    - utils/ (утилиты: keyboards, message_utils, time_utils)
    - constants.py, database.py, config.py, bot_app.py, main.py, requirements.txt
  - Скопированы все файлы из `WSB_portal/` (веб-портал) в `WSB_core/wsb_portal/`:
    - app/ (main.py, services/, static/, templates/)
    - Dockerfile, requirements.txt
  - Создана структура проекта с разделением на:
    - `wsb_core/` - общее ядро (models, constants, slots)
    - `wsb_bot/` - копия Telegram бота
    - `wsb_portal/` - копия веб-портала
- **Статус:** выполнено. Все файлы скопированы, структура создана. Дальнейшая разработка ведется только в `WSB_core/`.

## 2025-12-03 — Инициализация ядра WSB_core
- **Проблема:** Логика бронирований и уведомлений дублируется в нескольких проектах (WSB бот, WSB_portal, исторические версии ботов).
- **Подпроект:** WSB_core
- **Влияние:** Все проекты стека WSB (боты, веб‑портал, аналитика).
- **Причина:** Эволюционное развитие — каждый проект развивался отдельно, без общего ядра.
- **Решение:** Создан подпроект `WSB_core` для вынесения общих моделей и бизнес‑логики бронирований в единый модуль.
- **Статус:** инициализировано; наполнение ядра и подключение к существующим проектам будет выполняться поэтапно.
