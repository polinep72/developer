# История решений — WSB_core

## 2025-12-04 — Исправление ошибки освобождения слотов при досрочном завершении бронирования
- **Проблема:** При досрочном завершении бронирования (например, завершение в 7:38 вместо запланированного 9:00) слоты в `wsb_time_slots` не освобождались, и оборудование оставалось забронированным до исходного времени окончания. В портале оборудование показывалось как занятое до 9:00, хотя фактически было освобождено в 7:38.
- **Подпроект:** WSB_core
- **Влияние:** И бот, и портал теперь корректно освобождают слоты при досрочном завершении.
- **Причина:** Функция `finish_booking_core` обновляла только поле `finish` в таблице `bookings`, но не синхронизировала слоты в `wsb_time_slots`. Также логика расчёта доступных слотов не учитывала поле `finish` как эффективное время окончания бронирования.
- **Решение:**
  - В `wsb_core/slots.py` функция `calculate_available_slots_from_bookings` теперь использует `booking.get('finish')` как эффективное время окончания, если оно присутствует, иначе использует `booking['time_end']`.
  - В `wsb_bot/services/booking_service.py` удалено условие `AND b.finish IS NULL` из запроса `get_bookings_by_date`, чтобы завершённые бронирования учитывались в расчёте слотов с их фактическим временем завершения.
  - В `wsb_core/bookings_core.py` функция `finish_booking_core` теперь при `sync_slots=True` вызывает `_sync_slots` для освобождения слотов в `wsb_time_slots` от времени завершения (`finish_time`) до исходного времени окончания (`time_end`).
  - В `wsb_portal/app/services/bookings.py` функция `finish_booking` теперь вызывает `finish_booking_core` с параметром `sync_slots=True` для синхронизации слотов.
- **Статус:** выполнено. При досрочном завершении бронирования слоты корректно освобождаются, и оборудование становится доступным для бронирования сразу после завершения.

## 2025-12-04 — Исправление ошибок линтера в booking_service.py
- **Проблема:** Линтер выявил несколько ошибок типов в `wsb_bot/services/booking_service.py`:
  - Оператор `>` не поддерживается для типов `List[Dict[str, Any]]` и `Literal[0]` (строки 544, 578, 750).
  - Аргумент типа `Any | None` не может быть присвоен параметру `equipment_id` типа `int` (строка 721).
  - Аргумент типа `dict[str, Unknown]` не может быть присвоен параметру `params` типа `Tuple[Unknown, ...] | None` (строка 749).
- **Подпроект:** WSB_core/wsb_bot
- **Влияние:** Устранены предупреждения линтера, код стал более типобезопасным.
- **Причина:** Неправильное использование возвращаемого значения `execute_query` и некорректные типы параметров.
- **Решение:**
  - Удалены проверки `rows_affected > 0` для случаев, когда `execute_query` вызывается с `fetch_results=False` (метод возвращает `None` при успешном выполнении, исключение выбрасывается при ошибке).
  - Добавлена проверка `isinstance(equip_id, int)` перед вызовом `check_booking_conflict`.
  - Преобразован словарь параметров в кортеж для запроса продления бронирования (запрос переведён с именованных параметров `%(name)s` на позиционные `%s`).
- **Статус:** выполнено. Все критические ошибки линтера исправлены.

## 2025-12-04 — Ядро продления бронирований (extend_booking_core)
- **Проблема:** Логика продления бронирований реализована только в боте, в портале её не было; при этом проверки (рабочий день, лимиты, конфликты) были «зашиты» локально.
- **Подпроект:** WSB_core
- **Влияние:** И бот, и портал теперь используют одну и ту же бизнес‑логику продления.
- **Причина:** Необходимость убрать дублирование и гарантировать одинаковое поведение продления во всех интерфейсах.
- **Решение:**
  - В `wsb_core/bookings_core.py` добавлена функция `extend_booking_core`:
    - Проверяет права (владелец брони или админ).
    - Гарантирует, что продление не выходит за пределы рабочего дня (`WORKING_HOURS_END`).
    - Контролирует общий лимит длительности работы (`MAX_BOOKING_DURATION_HOURS`).
    - Проверяет конфликты с другими бронированиями в интервале продления.
    - Обновляет `time_end`, `time_interval`, `duration`, `extension` и при необходимости синхронизирует `wsb_time_slots`.
  - В `wsb_core/models.Booking` и вспомогательных функциях учтены все поля, необходимые для формирования понятного сообщения пользователю.
  - Портал (`wsb_portal/app/services/bookings.py`) переведён на использование `extend_booking_core` для операций продления.
  - Бот (`wsb_bot/services/booking_service.py`) использует `extend_booking_core` как основной путь и падает в локальную реализацию только как fallback.
- **Статус:** выполнено. Продление в боте и портале опирается на единое ядро.

## 2025-12-04 — Единая политика уведомлений (wsb_core.notifications_logic)
- **Проблема:** Правила, когда слать напоминания о начале/окончании работ и когда предлагать продление, были «размазаны» по коду бота и портала.
- **Подпроект:** WSB_core
- **Влияние:** Бот (Telegram) и портал (e‑mail) могут опираться на одну и ту же политику уведомлений.
- **Причина:** Требуется централизовать интервалы уведомлений и критерии валидности, чтобы избежать расхождений.
- **Решение:**
  - Создан модуль `wsb_core/notifications_logic.py`:
    - Константы:
      - `NOTIFICATION_BEFORE_START_MINUTES = 10` — напоминание о начале.
      - `NOTIFICATION_BEFORE_END_MINUTES = 10` — напоминание о скором окончании.
      - `SCHEDULER_TIMEZONE = "Europe/Moscow"` — базовая таймзона для планировщика.
    - Функции проверки валидности уведомления:
      - `is_booking_valid_for_start_notification(now, booking)` — бронь активна, ещё не началась, до старта не больше 10 минут.
      - `is_booking_valid_for_end_notification(now, booking)` — бронь активна, ещё не закончилась, до конца не больше 10 минут.
    - Политика продления:
      - `can_offer_extension_on_end(booking, now, has_conflicts_in_extension_window, extension_step_minutes=None)` — решает, можно ли показывать предложение продлить в уведомлении о завершении (бронь активна, есть свободное окно в пределах рабочего дня, нет конфликта).
  - Модуль не зависит от Telegram/SMTP, работает только с моделями и временем, и может использоваться как ботом, так и порталом.
- **Статус:** выполнено. Политика уведомлений вынесена в ядро; подключение к конкретным каналам (бот/e‑mail) выполняется по мере миграции.

## 2025-12-04 — Расширение моделей бронирования в wsb_core.models
- **Проблема:** Модели бронирования в `wsb_core.models` не соответствовали реальной структуре БД и не поддерживали все необходимые поля и статусы.
- **Подпроект:** WSB_core
- **Влияние:** Единообразие представления данных бронирования между ботом и порталом.
- **Причина:** Необходимость унификации моделей для корректной работы с данными из БД.
- **Решение:** 
  - Расширен `BookingStatus` добавлением статуса `PLANNED` (запланировано).
  - Расширена модель `Booking` для соответствия структуре БД:
    - Добавлены поля: `cancel`, `finish`, `time_interval`, `duration`, `data_booking`.
    - Добавлены поля из JOIN: `user_fio`, `equipment_name`.
    - Добавлено поле `date` для соответствия структуре БД.
  - Добавлена функция `determine_booking_status()` для определения статуса брони на основе полей БД.
  - Добавлена функция `booking_from_db_row()` для создания объекта Booking из строки БД с поддержкой разных вариантов именования полей (equip_id/equipment_id, user_fi/fio, name_equip/equipment_name).
  - Расширена модель `User` добавлением полей `email` и `is_active`.
- **Статус:** выполнено. Модели расширены и соответствуют структуре БД.

## 2025-12-04 — Общий модуль логики бронирований (wsb_core/bookings_core)
- **Проблема:** Логика создания и отмены бронирований дублировалась в портале и боте.
- **Подпроект:** WSB_core
- **Влияние:** Единая бизнес‑логика, синхронизация с `wsb_time_slots`, упрощение сопровождения.
- **Причина:** Требуется централизовать проверки рабочего времени, длительности, конфликтов и обновление таблиц при бронированиях.
- **Решение:**
  - Создан `wsb_core/bookings_core.py` с функциями `create_booking_core` и `cancel_booking_core`.
  - Добавлены проверки пользователя, рабочего времени, конфликтов, вставка/отмена с возвратом `Booking`.
  - Реализована синхронизация с `wsb_time_slots` и использование `wsb_core.models`.
  - `WSB_portal/app/services/bookings.py` переведён на использование ядра (кеши/уведомления остались на уровне портала).
- **Статус:** выполнено. Портал использует ядро для операций бронирования; следующий шаг — подключение Telegram‑бота.

## 2025-12-04 — Унификация логики генерации слотов через wsb_core.slots
- **Проблема:** Логика расчёта доступных слотов дублировалась в боте и портале, что могло приводить к расхождениям.
- **Подпроект:** WSB_core
- **Влияние:** Единообразие логики расчёта слотов между ботом и порталом.
- **Причина:** Необходимость унификации логики генерации слотов для обеспечения согласованности работы всей системы.
- **Решение:** 
  - Расширен `wsb_core/slots.py` функцией `calculate_available_slots_from_bookings()` для унифицированного расчёта слотов на основе списка бронирований.
  - Адаптирован `wsb_bot/services/booking_service.py` для использования `wsb_core.slots.calculate_available_slots_from_bookings()` вместо локальной реализации.
  - Сохранена локальная реализация как fallback (`_calculate_available_slots_local()`) на случай недоступности `wsb_core`.
  - Портал использует `wsb_time_slots` для работы с предрасчитанными слотами, но базовая логика шагов и рабочих часов общая.
- **Статус:** выполнено. Логика генерации слотов унифицирована, бот и портал используют общее ядро.

## 2025-12-04 — Унификация констант через wsb_core
- **Проблема:** Константы времени работы и шага бронирования различались между ботом (8:00–20:00) и порталом (7:00–22:00), что могло приводить к несоответствиям.
- **Подпроект:** WSB_core
- **Влияние:** Единообразие логики бронирований между ботом и порталом.
- **Причина:** Необходимость унификации констант для обеспечения согласованности работы всей системы.
- **Решение:** 
  - Обновлён `wsb_core/constants.py` с унифицированными константами: 7:00–22:00, шаг 30 минут, максимальная длительность 8 часов.
  - Адаптирован `wsb_bot/constants.py` для использования констант из `wsb_core.constants` с fallback на локальные значения.
  - Адаптирован `wsb_bot/services/booking_service.py` для использования констант из `wsb_core.constants`.
  - Обновлён `wsb_portal/app/services/bookings.py` для использования констант из `wsb_core.constants`.
  - Добавлена логика добавления корня проекта в PYTHONPATH для корректного импорта `wsb_core`.
- **Статус:** выполнено. Константы унифицированы, оба проекта используют значения из `wsb_core.constants`.

## 2025-12-04 — Копирование боевых версий в WSB_core
- **Проблема:** Необходимо работать над объединением бота и портала, не затрагивая боевые версии `WSB/` и `WSB_portal/`.
- **Подпроект:** WSB_core
- **Влияние:** Безопасность боевых систем, возможность разработки без риска для продакшена.
- **Причина:** Боевые версии зафиксированы (WSB_portal v0.3.8, WSB бот v5.1.0), все изменения должны происходить только в `WSB_core/`.
- **Решение:** 
  - Скопированы все файлы из `WSB/` (Telegram‑бот) в `WSB_core/wsb_bot/`:
    - `handlers/` (обработчики команд и callback'ов).
    - `services/` (бизнес‑логика: booking_service, equipment_service, notification_service и др.).
    - `utils/` (утилиты: keyboards, message_utils, time_utils).
    - `constants.py`, `database.py`, `config.py`, `bot_app.py`, `main.py`, `requirements.txt`.
  - Скопированы все файлы из `WSB_portal/` (веб‑портал) в `WSB_core/wsb_portal/`:
    - `app/` (main.py, services/, static/, templates/).
    - `Dockerfile`, `requirements.txt`.
  - Создана структура проекта с разделением на:
    - `wsb_core/` — общее ядро (models, constants, slots, bookings_core, notifications_logic).
    - `wsb_bot/` — копия Telegram‑бота.
    - `wsb_portal/` — копия веб‑портала.
- **Статус:** выполнено. Все файлы скопированы, структура создана. Дальнейшая разработка ведётся только в `WSB_core/`.

## 2025-12-03 — Инициализация ядра WSB_core
- **Проблема:** Логика бронирований и уведомлений дублировалась в нескольких проектах (WSB‑бот, WSB_portal, исторические версии ботов).
- **Подпроект:** WSB_core
- **Влияние:** Все проекты стека WSB (боты, веб‑портал, аналитика).
- **Причина:** Эволюционное развитие — каждый проект развивался отдельно, без общего ядра.
- **Решение:** Создан подпроект `WSB_core` для вынесения общих моделей и бизнес‑логики бронирований в единый модуль.
- **Статус:** инициализировано; наполнение ядра и подключение к существующим проектам выполняется поэтапно.
