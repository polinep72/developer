# WSB_core — единое ядро бронирования

## Назначение
`WSB_core` — это подпроект, в котором хранится **общее ядро логики бронирований** для всего WSB‑стека:
- общие модели (пользователи, оборудование, бронирования, статусы);
- общие функции работы с временными слотами и проверкой конфликтов;
- общие правила уведомлений (когда напоминать, можно ли продлевать, единые интервалы);
- общие утилиты для работы со временем и БД.

Цель: чтобы и Telegram‑бот (`WSB/wsb_bot`), и веб‑портал (`WSB_portal`) опирались на один и тот же код ядра, а не дублировали логику.

## Связанные подпроекты
- `WSB/` — боевой Telegram‑бот (версия 5.1.0).
- `WSB_portal/` — боевой веб‑портал бронирования (версия 0.3.8, зафиксирована и не изменяется).
- `telegram_bot_WorkSpaceBooking/` — исторический бот на CSV (источник бизнес‑правил и сценариев).

## Текущая структура проекта

```
WSB_core/
├── wsb_core/               # Общее ядро логики
│   ├── models.py           # Общие модели (User, Equipment, Booking, TimeSlot, BookingStatus)
│   ├── constants.py        # Общие константы (WORKING_HOURS_START, WORKING_HOURS_END, BOOKING_TIME_STEP_MINUTES, MAX_BOOKING_DURATION_HOURS)
│   ├── slots.py            # Генерация слотов, работа с wsb_time_slots
│   ├── bookings_core.py    # Единая бизнес‑логика бронирований (create/cancel/extend, конфликты, синхронизация слотов)
│   └── notifications_logic.py # Единая политика уведомлений (когда слать, можно ли предлагать продление, TZ)
├── wsb_bot/                # Копия Telegram‑бота (из WSB/), адаптированная под ядро
│   ├── main.py             # Точка входа тестового бота WSB_core
│   ├── config.py           # Настройки, приоритет загрузки .env из корня WSB_core
│   ├── constants.py        # Константы бота (тексты, callback‑коды), часть тянется из wsb_core.constants
│   ├── database.py         # Подключение к БД, пул соединений
│   ├── handlers/           # Обработчики команд и callback'ов (user_commands, admin_commands, callback_handlers, registration)
│   ├── services/           # Бизнес‑логика (booking_service, equipment_service, user_service, notification_service и др.)
│   └── utils/              # Утилиты (keyboards, message_utils, time_utils)
├── wsb_portal/             # Копия веб‑портала (из WSB_portal/), адаптированная под ядро
│   ├── app/
│   │   ├── main.py         # FastAPI приложение (портал WSB_core, порт 8088)
│   │   ├── services/       # Бизнес‑логика (bookings, heatmap, dashboard, equipment, notifications)
│   │   ├── static/         # CSS, JS, изображения
│   │   └── templates/      # HTML‑шаблоны
│   ├── Dockerfile
│   └── requirements.txt
├── core_app/               # Тестовое FastAPI‑приложение для отладки ядра (опционально)
├── scripts/                # Скрипты для работы с БД (создание таблиц, отладка)
├── PROJECT_CONTEXT.md      # Текущий файл контекста
├── SOLUTIONS_HISTORY.md    # История решенных задач
├── CHANGELOG.md            # История изменений проекта (SemVer)
├── CHAT_HISTORY.md         # Сжатая история переписки по WSB_core
└── docker-compose.yml      # Docker Compose для запуска всего стека (пока не финализирован)
```

## Статус проекта

**Текущая версия ядра:** 0.1.0 (начальная версия после копирования файлов и первых унификаций)

**Ключевые договоренности:**
- Боевые версии `WSB/` и `WSB_portal/` **зафиксированы** и не изменяются.
- Вся новая разработка и эксперименты ведутся **только в `WSB_core/`**.
- Ядро отвечает за: модели, слоты, константы, логику create/cancel/extend, правила уведомлений.
- Бот и портал постепенно переводятся на использование ядра без изменения боевого кода.

## Известные реализованные элементы

- **Модели (`wsb_core.models`):**
  - `BookingStatus` с динамическим определением статуса по `cancel/finish/time_end`, без использования устаревшего столбца `status` в БД.
  - `Booking` с полями, соответствующими реальной схеме БД (`cancel`, `finish`, `time_interval`, `duration`, `data_booking`, `user_fio`, `equipment_name`, `date`).
  - Функции `determine_booking_status()` и `booking_from_db_row()` для безопасного создания объектов из сырых строк БД.

- **Константы (`wsb_core.constants`):**
  - Рабочий день: 07:00–22:00.
  - Шаг бронирования: 30 минут.
  - Максимальная длительность одной брони: 8 часов.
  - Бот и портал используют эти значения через импорт, локальные константы оставлены только как fallback.

- **Слоты (`wsb_core.slots`):**
  - Генерация дневных слотов и работа с таблицей `wsb_time_slots`.
  - Унифицированная функция `calculate_available_slots_from_bookings()` для расчета свободных интервалов по списку броней.
  - Портал использует `wsb_time_slots`, бот — расчёт по броням; логика шагов и рабочих часов общая.

- **Ядро бронирований (`wsb_core.bookings_core`):**
  - `create_booking_core`: единые проверки (пользователь активен, рабочий день, длительность, конфликты), вставка в `bookings`, опциональная синхронизация `wsb_time_slots`.
  - `cancel_booking_core`: проверка прав, статуса, установка `cancel = TRUE`, опциональная синхронизация слотов.
  - `extend_booking_core`: единая логика продления (права, рабочий день, общий лимит MAX_DURATION, конфликты, обновление `time_end/time_interval/duration/extension`, опциональный `wsb_time_slots`).
  - Все функции возвращают `BookingCoreResult` с полным объектом `Booking` и служебной информацией (`old_end/new_end`, конфликты и т.п.).

- **Политика уведомлений (`wsb_core.notifications_logic`):**
  - Константы:
    - `NOTIFICATION_BEFORE_START_MINUTES = 10` — напоминание о начале.
    - `NOTIFICATION_BEFORE_END_MINUTES = 10` — напоминание о скором окончании.
    - `SCHEDULER_TIMEZONE = "Europe/Moscow"` — базовая таймзона для планировщика и форматов времени.
  - Функции:
    - `is_booking_valid_for_start_notification(now, booking)` — решает, есть ли смысл слать уведомление о начале (бронь активна, ещё не началась, окно до начала не больше 10 минут).
    - `is_booking_valid_for_end_notification(now, booking)` — аналогично для окончания.
    - `can_offer_extension_on_end(booking, now, has_conflicts_in_extension_window, extension_step_minutes=None)` — решает, можно ли предлагать продление в конце (бронь активна, не вышли за рамки рабочего дня, нет конфликта в ближайшем шаге).
  - Эти функции используются как единый источник бизнес‑решений для уведомлений (бот и портал).

- **Бот (`wsb_bot`) в контексте ядра:**
  - Копирует боевую логику, но:
    - `services/booking_service.extend_booking` использует `wsb_core.bookings_core.extend_booking_core` с fallback на локальную реализацию.
    - Команда `/extend` и кнопка «⏳ Продлить бронь» работают через боевой `callback_handlers`, но обновлённый `booking_service` уже завязан на ядро.
    - Обработчики и сервисы, где логика полностью устоялась (user_service, equipment_service и др.), подключены через прокси к боевым модулям.

- **Портал (`wsb_portal`) в контексте ядра:**
  - `app/services/bookings.py` использует `create_booking_core`, `cancel_booking_core`, `extend_booking_core` вместо локального SQL.
  - Кнопка «Продлить» на вкладке управления бронированием использует ядро продления и показывает новое время окончания.
  - Локальный модуль `app/services/notifications.py` отвечает за отправку e‑mail и в дальнейшем может использовать политику из `wsb_core.notifications_logic`.

## Известные проблемы / ограничения

- Логика уведомлений бота по‑прежнему реализована в боевом `services/notification_service.py` и пробрасывается в дубль через прокси; ядро пока используется как источник политики, а не как полный заменитель.
- E‑mail‑уведомления портала живут в `WSB_portal/app/services/notifications.py` и не интегрированы напрямую с APScheduler бота (это разные каналы уведомлений).
- Docker‑конфигурация `docker-compose.yml` для совместного запуска бота+портала+ядра не финализирована.

## План работ (актуальный)

1. ✅ Скопировать все необходимые файлы из `WSB/` и `WSB_portal/` в `WSB_core/`.
2. ✅ Адаптировать импорты в скопированных файлах для работы с `wsb_core`.
3. ✅ Унифицировать константы через `wsb_core.constants`.
4. ✅ Унифицировать логику генерации слотов через `wsb_core.slots`.
5. ✅ Расширить модели бронирования в `wsb_core.models` (Booking, BookingStatus, функции преобразования).
6. ✅ Создать единое ядро бронирований `wsb_core.bookings_core` и подключить к порталу (create/cancel/extend).
7. ✅ Перевести продление в боте и портале на `wsb_core.bookings_core.extend_booking_core` (с fallback в боте).
8. ✅ Вынести общие правила уведомлений в `wsb_core.notifications_logic`.
9. ⏳ Постепенно использовать `wsb_core.notifications_logic` в e‑mail‑уведомлениях портала (единые интервалы и проверки).
10. ⏳ Протестировать работу бота и портала из `WSB_core` на одном и том же бронировании (создание → продление в портале → продление в боте → отмена).
11. ⏳ После стабилизации — подготовить Docker‑окружение и сценарий миграции на ядро без остановки боевых систем.

Этот файл нужно обновлять при каждом крупном изменении ядра (новые модули, смена схемы работы, подключение новых подпроектов).
