# Crystal Wafer Management System

Система управления складом кристаллов и пластин для ИПК ЭЛЕКТРОН-МАШ.

## Версия
**Текущая версия: 1.4.6**

## Описание проекта

Веб-приложение для управления складскими операциями с кристаллами и пластинами. Система поддерживает работу с несколькими типами складов:
- Склад кристаллов
- Склад пластин
- Дальний склад

## Основной функционал

### Управление складами
- Поиск кристаллов по различным критериям (доступен без авторизации)
- Загрузка данных о приходе товара (требуется авторизация)
- Загрузка данных о расходе товара (требуется авторизация)
- Загрузка данных о возврате товара (требуется авторизация)
- Инвентаризация с фильтрацией и экспортом (требуется авторизация)
- Корзина покупок с разделением по складам (доступна без авторизации)

### Технические особенности
- Динамический выбор таблиц БД в зависимости от типа склада
- Оптимизированная обработка больших файлов Excel
- Визуальная обратная связь при загрузке данных
- Экспорт данных в Excel с различными форматами

## Технологии

- **Backend**: Python 3.14, Flask
- **Database**: PostgreSQL
- **Frontend**: HTML, CSS, JavaScript, Jinja2 templates
- **Data Processing**: Pandas, openpyxl

## Установка и запуск

### Требования
- Python 3.14+
- PostgreSQL
- Зависимости из `requirements.txt`

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка окружения
Создайте файл `.env` в корне проекта:
```
DB_HOST=192.168.1.139
DB_NAME=ElEngine
DB_USER=your_username
DB_PASSWORD=your_password
DB_PORT=5432
```

### Запуск приложения

**Режим разработки (development):**
```bash
cd web_app_WebChip
python app.py
```
Используется встроенный сервер Flask (только для разработки и тестирования).

**Production режим:**
1. Добавьте в `.env` файл:
```env
MODE=production
```

2. Запустите приложение:
```bash
cd web_app_WebChip
python app.py
```
Приложение автоматически запустится через Waitress WSGI сервер (production-ready).

**Альтернативный запуск через Uvicorn (для Linux/Docker):**
```bash
uvicorn app:app --host 0.0.0.0 --port 8089
```

Приложение будет доступно по адресу: `http://localhost:8089`

## Структура проекта

```
crystal_wafer/
├── web_app_WebChip/          # Основное веб-приложение
│   ├── app.py                # Главный файл приложения
│   ├── templates/            # HTML шаблоны
│   ├── static/               # Статические файлы (CSS, изображения)
│   └── requirements.txt      # Зависимости Python
├── CHANGELOG.md              # История изменений
├── PROJECT_CONTEXT.md        # Контекст проекта
├── SOLUTIONS_HISTORY.md      # История решений проблем
└── README.md                 # Этот файл
```

## История версий

См. [CHANGELOG.md](CHANGELOG.md) для подробной истории изменений.

### Версия 1.4.4 (2025-12-16)
- Добавлено ограничение размера загружаемых файлов (10 MB) для защиты от DoS атак
- Обработчик ошибки 413 с понятными сообщениями для пользователя

### Версия 1.4.3 (2025-12-16)
- Добавлена валидация имен таблиц и столбцов (whitelist) для защиты от SQL injection
- Унифицирована кнопка "Главное меню" во всех шаблонах (синий цвет)

### Версия 1.4.2 (2025-12-16)
- Добавлена система аудита действий пользователей (Audit Log)
- Улучшена безопасность сессий (SHA-256, безопасные cookie)

### Версия 1.4.1 (2025-12-16)
- Добавлен rate limiting для защиты от брутфорса паролей
- Добавлена CSRF защита для всех форм и AJAX запросов

### Версия 1.4.0 (2025-12-16)
- Добавлена валидация входных данных (защита от XSS)

### Версия 1.3.9 (2025-12-16)
- Исправлен поиск по шифру кристалла - теперь ищет точное вхождение последовательности символов
- Исправлены ошибки индентации в коде
- Добавлена конфигурация pyrightconfig.json для подавления предупреждений линтера

### Версия 1.3.8 (2025-12-16)
- Логотип теперь кликабелен и ведет на главную страницу во всех шаблонах
- Добавлен визуальный эффект при наведении на логотип

### Версия 1.3.7 (2025-12-16)
- Добавлен личный кабинет пользователя с возможностью редактирования всех данных
- Исправлена ошибка удаления пользователя (удаление связанных записей)
- Улучшена безопасность - секретные ответы проверяются только в захешированном виде
- Исправлена кодировка email уведомлений (UTF-8)
- Имя пользователя в интерфейсе теперь кликабельно и ведет в личный кабинет

### Версия 1.3.6 (2025-12-12)
- **Безопасность:** Реализовано хеширование паролей для всех пользователей
- Добавлен модуль восстановления пароля через секретный вопрос
- При регистрации пользователь задает свой секретный вопрос и ответ
- Исправлен SECRET_KEY - автоматическая генерация безопасного ключа
- Выполнена миграция всех существующих паролей на хеширование

### Версия 1.3.5 (2025-12-11)
- Поиск и корзина теперь доступны без авторизации для неавторизованных пользователей
- Исправлен редирект на страницу входа при выполнении поиска без авторизации
- Для неавторизованных пользователей используются временные идентификаторы на основе уникального ID сессии
- Поиск работает без авторизации на всех трёх складах
- Неавторизованные пользователи могут добавлять товары в корзину без входа в систему
- Для неавторизованных пользователей используются временные идентификаторы на основе уникального ID сессии
- Убраны проверки авторизации для функций поиска и работы с корзиной

### Версия 1.3.4 (2025-12-11)
- Унифицирован интерфейс поиска для всех типов складов
- Фильтр по партии теперь доступен на всех складах
- Удален фильтр по пластине для единообразия интерфейса

### Версия 1.3.3 (2025-12-11)
- Добавлена система отправки критических ошибок на email администратору
- Поддержка корпоративных SMTP серверов
- Автоматический запуск через Waitress WSGI сервер в production режиме

### Версия 1.3.2 (2025-12-10)
- Добавлен фильтр по пластине для складов "Склад пластин" и "Дальний склад"
- Исправлена ошибка SQL при добавлении в корзину

### Версия 1.3.1 (2025-12-09)
- Добавлен 3D эффект для заголовков и стеклянный стиль для кнопок главной страницы
- Улучшено выравнивание элементов на странице инвентаризации

### Версия 1.3.0 (2025-12-09)
- Добавлена возможность удаления элементов из корзины
- Улучшен интерфейс корзины: единообразные размеры кнопок, вертикальное расположение
- Добавлен динамический фильтр партий при поиске
- Исправлены проблемы с агрегацией и отображением данных

### Версия 1.2.0 (2025-12-09)
- Добавлена поддержка нескольких типов складов
- Реализованы отдельные корзины для каждого склада
- Добавлены индикаторы загрузки
- Оптимизирована работа с базой данных
- Улучшена обработка ошибок

### Версия 1.1.0 (2025-12-08)
- Добавлены вкладки для разных складов
- Исправлены проблемы авторизации

## База данных

### Структура таблиц по складам:
- **Склад кристаллов**: `invoice`, `consumption`
- **Склад пластин**: `invoice_p`, `consumption_p`
- **Дальний склад**: `invoice_f`, `consumption_f`
- **Корзина**: `cart` (с полем `warehouse_type`)

## Настройка уведомлений об ошибках

Система поддерживает отправку критических ошибок на email администратору. Для настройки добавьте следующие переменные в файл `.env`:

```env
# Настройки SMTP для отправки критических ошибок
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your_email@gmail.com
SMTP_PASSWORD=your_app_password
SMTP_FROM_EMAIL=your_email@gmail.com
SMTP_USE_TLS=true
ADMIN_EMAIL=admin@example.com
```

**Примечания:**
- Если настройки SMTP не указаны, система будет работать без отправки email, но будет выводить предупреждение в лог
- На email отправляются только ошибки уровня ERROR и CRITICAL
- **Для Gmail необходимо использовать "Пароль приложения" (App Password), а не обычный пароль:**
  
  **Важно:** Сначала обязательно включите двухэтапную аутентификацию, без неё пароли приложений недоступны.
  
  **Способы создания пароля приложения:**
  
  **Способ 1 (прямая ссылка - самый надежный):**
  1. После включения двухэтапной аутентификации перейдите по прямой ссылке:
     ```
     https://myaccount.google.com/apppasswords
     ```
  2. Выберите приложение "Почта" и устройство "Другое", введите название (например, "Crystal Wafer System")
  3. Скопируйте сгенерированный 16-символьный пароль (без пробелов)
  
  **Способ 2 (через настройки):**
  1. Войдите в аккаунт Google
  2. Перейдите в "Управление аккаунтом Google" → "Безопасность"
  3. После включения двухэтапной аутентификации найдите раздел "Пароли приложений"
     - Если не видите раздел, используйте поиск на странице (Ctrl+F) и ищите "пароль приложения" или "app password"
  4. Следуйте инструкциям способа 1 с шага 2
  
  **Если пароли приложений недоступны (сообщение "Эта настройка недоступна для вашего аккаунта"):**
  
  Это означает, что либо это корпоративный аккаунт Google Workspace, либо функция отключена администратором.
  
  **Варианты решения:**
  
  1. **Использовать корпоративный почтовый SMTP сервер (рекомендуется):**
     - Узнайте у IT-отдела настройки SMTP сервера вашей компании
     - Обычно это что-то вроде: `mail.company.ru`, `smtp.company.ru` или `smtp.office365.com`
     - Обновите `.env` файл с этими настройками:
       ```env
       SMTP_HOST=smtp.company.ru
       SMTP_PORT=587
       SMTP_USERNAME=your_email@company.ru
       SMTP_PASSWORD=your_company_password
       SMTP_FROM_EMAIL=your_email@company.ru
       SMTP_USE_TLS=true
       ADMIN_EMAIL=admin@company.ru
       ```
  
  2. **Работать без email-уведомлений:**
     - Система будет работать нормально, но без отправки email на критические ошибки
     - Все ошибки будут логироваться в консоль/лог-файлы
     - Просто не указывайте настройки SMTP в `.env` или удалите их
  
  3. **Обратиться к администратору Google Workspace:**
     - Попросите включить пароли приложений для вашего аккаунта
     - Или запросите доступ к корпоративному SMTP серверу
  
  **После настройки:**
  - Перезапустите приложение для применения настроек SMTP
- Система автоматически определяет наличие настроек SMTP при запуске
- При ошибках SMTP аутентификации система продолжит работу, но не будет отправлять email уведомления

## Контакты и поддержка

Для вопросов и предложений обращайтесь к команде разработки ИПК ЭЛЕКТРОН-МАШ.

## Лицензия

Внутренний проект ИПК ЭЛЕКТРОН-МАШ.

