# API Документация Crystal Wafer Management System

## Версия API: v1.0

## Базовый URL
```
/api/v1
```

## Стандартный формат ответа

Все ответы API имеют единообразный формат:

```json
{
  "success": true,
  "version": "1.0",
  "data": { ... },
  "message": "Опциональное сообщение",
  "errors": ["Список ошибок, если success = false"]
}
```

### Поля ответа

- `success` (boolean) - Успешность операции
- `version` (string) - Версия API (всегда "1.0")
- `data` (object/array) - Данные ответа (присутствует при успехе)
- `message` (string, опционально) - Текстовое сообщение
- `errors` (array, опционально) - Список ошибок (присутствует при ошибке)

## Коды состояния HTTP

- `200 OK` - Успешный запрос
- `400 Bad Request` - Неверные параметры запроса
- `401 Unauthorized` - Требуется авторизация
- `404 Not Found` - Ресурс не найден
- `500 Internal Server Error` - Внутренняя ошибка сервера
- `501 Not Implemented` - Метод не реализован

---

## Endpoints

### 1. Поиск кристаллов

**GET** `/api/v1/search`

Поиск кристаллов с фильтрацией и пагинацией.

#### Параметры запроса

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `warehouse` | string | Нет | `crystals` | Тип склада: `crystals`, `plates`, `far` |
| `chip_name` | string | Нет | - | Шифр кристалла (поиск по подстроке) |
| `manufacturer` | string | Нет | `all` | Производитель (или `all` для всех) |
| `lot` | string | Нет | `all` | Партия (или `all` для всех) |
| `page` | integer | Нет | `1` | Номер страницы (начиная с 1) |
| `per_page` | integer | Нет | `50` | Количество результатов на странице (1-200) |

#### Пример запроса

```
GET /api/v1/search?warehouse=crystals&chip_name=308&manufacturer=ALL&page=1&per_page=50
```

#### Пример ответа

```json
{
  "success": true,
  "version": "1.0",
  "data": {
    "results": [
      {
        "item_id": 12345,
        "chip_code": "HJB313",
        "manufacturer": "ALL",
        "lot": "123456",
        "technology": "CMOS",
        "wafer": "6",
        "quadrant": "A",
        "internal_lot": "INT001",
        "start": "START01",
        "storage": "STORAGE1",
        "cells": "CELLS1",
        "balance_w": 100,
        "balance_gp": 50,
        "note": "Примечание"
      }
    ],
    "pagination": {
      "page": 1,
      "per_page": 50,
      "total_pages": 5,
      "total_count": 234
    },
    "filters": {
      "warehouse": "crystals",
      "chip_name": "308",
      "manufacturer": "ALL",
      "lot": "all"
    }
  }
}
```

---

### 2. Получение списка шифров кристаллов

**GET** `/api/v1/chip-codes`

Получение списка уникальных шифров кристаллов с возможностью фильтрации.

#### Параметры запроса

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `q` | string | Нет | - | Фильтр по подстроке (поиск начинается с этой строки) |

#### Пример запроса

```
GET /api/v1/chip-codes?q=HJB
```

#### Пример ответа

```json
{
  "success": true,
  "version": "1.0",
  "data": {
    "chip_codes": [
      "HJB313",
      "HJB315",
      "HJB400"
    ]
  }
}
```

**Примечание:** Если параметр `q` не указан, возвращаются популярные шифры (те, которые встречаются в таблице `invoice`).

---

### 3. Получение списка производителей

**GET** `/api/v1/manufacturers`

Получение списка всех производителей.

#### Параметры запроса

Нет параметров.

#### Пример запроса

```
GET /api/v1/manufacturers
```

#### Пример ответа

```json
{
  "success": true,
  "version": "1.0",
  "data": {
    "manufacturers": [
      "ALL",
      "MANUFACTURER1",
      "MANUFACTURER2"
    ]
  }
}
```

---

### 4. Получение списка партий

**GET** `/api/v1/lots`

Получение списка партий с возможностью фильтрации по складу и производителю.

#### Параметры запроса

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `warehouse` | string | Нет | `crystals` | Тип склада: `crystals`, `plates`, `far` |
| `manufacturer` | string | Нет | `all` | Производитель (или `all` для всех партий) |

#### Пример запроса

```
GET /api/v1/lots?warehouse=crystals&manufacturer=ALL
```

#### Пример ответа

```json
{
  "success": true,
  "version": "1.0",
  "data": {
    "lots": [
      "123456",
      "123457",
      "123458"
    ]
  }
}
```

---

### 5. Получение корзины пользователя

**GET** `/api/v1/cart`

Получение списка товаров в корзине пользователя.

#### Параметры запроса

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `warehouse` | string | Нет | Из сессии | Тип склада: `crystals`, `plates`, `far` |

#### Пример запроса

```
GET /api/v1/cart?warehouse=crystals
```

#### Пример ответа

```json
{
  "success": true,
  "version": "1.0",
  "data": {
    "cart_items": [
      {
        "item_id": 1,
        "user_id": 2,
        "start": "START01",
        "manufacturer": "ALL",
        "technology": "CMOS",
        "wafer": "6",
        "quadrant": "A",
        "lot": "123456",
        "internal_lot": "INT001",
        "chip_code": "HJB313",
        "note": "Примечание",
        "stor": "STORAGE1",
        "cells": "CELLS1",
        "date_added": "2025-12-17T10:30:00",
        "cons_w": 10,
        "cons_gp": 5
      }
    ],
    "warehouse_type": "crystals"
  }
}
```

**Примечание:** Корзина доступна для неавторизованных пользователей (используется временный ID пользователя).

---

### 6. Удаление товара из корзины

**DELETE** `/api/v1/cart/<item_id>`

Удаление товара из корзины пользователя.

#### Параметры пути

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `item_id` | integer | Да | ID товара в корзине |

#### Параметры запроса

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `warehouse` | string | Нет | Из сессии | Тип склада: `crystals`, `plates`, `far` |

#### Пример запроса

```
DELETE /api/v1/cart/123?warehouse=crystals
```

#### Пример ответа (успех)

```json
{
  "success": true,
  "version": "1.0",
  "message": "Товар удален из корзины"
}
```

#### Пример ответа (товар не найден)

```json
{
  "success": false,
  "version": "1.0",
  "message": "Товар не найден в корзине"
}
```

**Коды состояния:**
- `200 OK` - Товар успешно удален
- `404 Not Found` - Товар не найден в корзине
- `400 Bad Request` - Неверный ID товара

---

## Примеры использования

### Пример 1: Поиск кристаллов с фильтрацией

```bash
curl "http://localhost:5000/api/v1/search?warehouse=crystals&chip_name=HJB&manufacturer=ALL&page=1&per_page=25"
```

### Пример 2: Получение автодополнения для шифров

```bash
curl "http://localhost:5000/api/v1/chip-codes?q=HJB"
```

### Пример 3: Удаление товара из корзины

```bash
curl -X DELETE "http://localhost:5000/api/v1/cart/123?warehouse=crystals"
```

---

## Обработка ошибок

### Пример ответа с ошибкой

```json
{
  "success": false,
  "version": "1.0",
  "message": "Ошибка получения данных",
  "errors": ["Детальное описание ошибки"]
}
```

### Типичные ошибки

1. **400 Bad Request** - Неверные параметры запроса
   ```json
   {
     "success": false,
     "version": "1.0",
     "message": "Неверный ID товара"
   }
   ```

2. **401 Unauthorized** - Требуется авторизация (для защищенных endpoints)
   ```json
   {
     "success": false,
     "version": "1.0",
     "message": "Требуется авторизация"
   }
   ```

3. **500 Internal Server Error** - Внутренняя ошибка сервера
   ```json
   {
     "success": false,
     "version": "1.0",
     "message": "Ошибка получения данных: [детали ошибки]"
   }
   ```

---

## Версионирование

Текущая версия API: **v1.0**

Все endpoints доступны по префиксу `/api/v1/`. В будущих версиях может быть добавлена поддержка других версий (например, `/api/v2/`).

---

## Ограничения

1. **Rate Limiting**: Применяются ограничения на количество запросов (200 запросов в день, 50 запросов в час с одного IP адреса)

2. **Пагинация**: Максимальное количество результатов на странице: 200

3. **Размер запроса**: Максимальный размер загружаемого файла: 10 MB

---

## Автор

**Автор идеи и разработчик:** Полин Е.П.  
**Telegram:** @PolinEP  
**E-mail:** polin-ep@yandex.ru  

**Соразработчик:** Cursor  

**Лицензионные права:** ИнноЦентр ВАО и ИПК Электрон-Маш

