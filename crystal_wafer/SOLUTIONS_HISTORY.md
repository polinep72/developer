# История решенных проблем

## 2025-12-16

### Проблема: Накопление flash-сообщений на странице логина
**Подпроект:** web_app_WebChip  
**Описание:** После выхода из системы на странице логина отображались все накопленные flash-сообщения из сессии, включая старые сообщения с других страниц (например, "По вашему запросу ничего не найдено").

**Решение:**
- Изменена функция logout() для использования session.clear() вместо отдельных session.pop()
- Добавлено автоматическое скрытие flash-сообщений через 5 секунд с плавной анимацией
- Добавлена кнопка закрытия (×) для каждого flash-сообщения, позволяющая закрыть его вручную
- Добавлена фильтрация сообщений по категориям для отображения только релевантных сообщений

**Статус:** ✅ Решено  
**Версия:** 1.4.9

---

### Проблема: Автодополнение и подсказки
**Подпроект:** web_app_WebChip  
**Описание:** Нет подсказок при вводе поисковых запросов. Пользователи не знают, какие шифры кристаллов доступны, и могут допускать опечатки.

**Решение:**
- Создан API endpoint `/api/get_chip_codes` для получения списка уникальных шифров кристаллов
- Добавлен HTML5 datalist для автодополнения в полях поиска шифров кристаллов
- Реализован JavaScript для динамической загрузки списка шифров с фильтрацией по введенному тексту (debounce 300ms)
- Добавлены title атрибуты с описаниями для всех полей ввода (производитель, партия, шифр кристалла)
- Автодополнение реализовано в search.html и inventory.html
- При вводе текста автоматически загружаются подходящие варианты (до 50 при фильтрации, до 100 популярных при загрузке)

**Статус:** ✅ Решено  
**Версия:** 1.4.8

---

### Проблема: Улучшенная обработка ошибок на клиенте
**Подпроект:** web_app_WebChip  
**Описание:** Использование alert() для сообщений об ошибках было неудобно. Нужна более современная система уведомлений с автоматическим исчезновением.

**Решение:**
- Создана универсальная функция showToast() для всех шаблонов
- Добавлены стили для toast-уведомлений (success, error, warning, info)
- Заменены все alert() на toast-уведомления в основных шаблонах:
  - profile.html - все сообщения теперь через toast
  - cart.html - обновление количества, удаление, экспорт
  - search.html - добавление в корзину, ошибки загрузки партий
  - manage_users.html - обновление и удаление пользователей
- Улучшена обработка AJAX ошибок с понятными сообщениями для пользователя
- Добавлены сообщения об ошибках подключения к интернету
- Toast-уведомления автоматически исчезают через несколько секунд
- Визуальное различие типов уведомлений

**Статус:** ✅ Решено  
**Версия:** 1.4.7

---

### Проблема: Валидация форм на клиенте
**Подпроект:** web_app_WebChip  
**Описание:** Валидация происходила только на сервере, пользователь узнавал об ошибках после отправки формы. Использовались alert() для сообщений об ошибках, что неудобно.

**Решение:**
- Добавлена HTML5 валидация с использованием атрибутов pattern, minlength, maxlength, title для всех форм
- Создана система toast-уведомлений для замены alert() в формах регистрации и восстановления пароля
- Добавлена валидация в реальном времени для полей паролей (проверка совпадения при потере фокуса)
- Добавлена визуальная обратная связь для валидных/невалидных полей (цвет границы)
- Улучшена валидация в register.html, login.html, profile.html, forgot_password.html
- Добавлены функции showFieldError/hideFieldError для показа ошибок под полями ввода
- Добавлены autocomplete атрибуты для улучшения UX

**Статус:** ✅ Решено  
**Версия:** 1.4.6

---

### Проблема: Защита от перечисления пользователей
**Подпроект:** web_app_WebChip  
**Описание:** Разные сообщения об ошибке при неверном логине/пароле позволяли перечислить пользователей и узнать, существует ли пользователь в системе. Также специальное сообщение для заблокированных пользователей утечкало информацию.

**Решение:**
- Всегда показывается одинаковое сообщение "Неверное имя пользователя или пароль" при любой ошибке входа
- Убрано специальное сообщение для заблокированных пользователей - проверка блокировки объединена с проверкой пароля
- Добавлена задержка 500ms перед возвратом ошибки для замедления брутфорса паролей
- В функции `forgot_password` всегда показывается форма с секретным вопросом, даже для несуществующих пользователей (показывается общий вопрос)
- Все логирование сохранено для аудита, но пользователю не показывается разная информация

**Статус:** ✅ Решено  
**Версия:** 1.4.5

---

### Проблема: Ограничение размера загружаемых файлов для защиты от DoS атак
**Подпроект:** web_app_WebChip  
**Описание:** Необходимо добавить ограничение размера загружаемых файлов для защиты от DoS атак через большие файлы и переполнение памяти.

**Решение:**
- Добавлена константа `MAX_FILE_SIZE = 10 * 1024 * 1024` (10 MB)
- Установлена конфигурация Flask `MAX_CONTENT_LENGTH` для автоматической проверки размера
- Добавлен обработчик ошибки 413 (RequestEntityTooLarge) с понятными сообщениями для пользователя
- Добавлена проверка размера файла в функциях `/inflow`, `/outflow`, `/refund` перед обработкой через `file.seek()` и `file.tell()`
- Добавлено логирование попыток загрузки файлов, превышающих лимит
- Обработчик ошибки 413 правильно обрабатывает как JSON, так и обычные запросы

**Статус:** ✅ Решено  
**Версия:** 1.4.4

---

### Проблема: Валидация имен таблиц и столбцов (whitelist) для защиты от SQL injection
**Подпроект:** web_app_WebChip  
**Описание:** Необходимо добавить валидацию имен таблиц и столбцов для защиты от SQL injection через динамические имена таблиц/столбцов.

**Решение:**
- Созданы whitelist разрешенных таблиц (24 таблицы) и столбцов (15 столбцов)
- Добавлены функции `validate_table_name()` и `validate_column_name()` для проверки имен
- Валидация применена ко всем функциям `get_or_create_id()` и `get_reference_id()`
- Валидация применена ко всем локальным функциям `get_or_create_id_with_cursor()` и `get_reference_id_with_cursor()`
- Все использования `invoice_table` и `consumption_table` валидируются через `validate_table_name()`
- При попытке использовать недопустимое имя таблицы/столбца генерируется ValueError с логированием ошибки

**Статус:** ✅ Решено  
**Версия:** 1.4.3

---

### Проблема: Ошибки отступов (IndentationError) после реализации audit log
**Подпроект:** web_app_WebChip  
**Описание:** После реализации системы аудита логирования действий пользователей возникли множественные ошибки IndentationError в различных функциях.

**Причина:** При редактировании кода были случайно изменены отступы в нескольких местах.

**Решение:**
- Исправлены отступы для проверки `GelPack` колонок в функциях `inflow`, `outflow`, `refund`
- Исправлены отступы для `params_search` и `filter_conditions` в функции `search`
- Исправлены отступы в блоке `else` функции `add_to_cart` для склада кристаллов

**Статус:** ✅ Решено  
**Версия:** 1.4.2

---

### Проблема: Реализация системы аудита логирования действий пользователей (Audit Log)
**Подпроект:** web_app_WebChip  
**Описание:** Необходимо реализовать полноценную систему логирования действий пользователей для аудита.

**Решение:**
- Создана таблица `audit_log` с полями: user_id, action_type, table_name, record_id, details, ip_address, user_agent, created_at
- Создан SQL скрипт `create_audit_log.sql` с индексами для быстрого поиска
- Улучшена функция `log_user_action` с поддержкой IP адреса и User-Agent
- Добавлено логирование критичных действий: login, logout, update, delete, export, file_upload
- Создан Python скрипт `create_audit_log_migration.py` для миграции на других базах

**Статус:** ✅ Решено  
**Версия:** 1.4.2

---

### Проблема: Rate limiting для защиты от брутфорса паролей
**Подпроект:** web_app_WebChip  
**Описание:** Необходимо добавить защиту от брутфорса паролей через rate limiting.

**Решение:**
- Добавлен Flask-Limiter для ограничения количества запросов
- Настроено ограничение: 5 попыток входа в минуту с одного IP
- Общие ограничения: 200 запросов в день, 50 в час на все эндпоинты
- Добавлен обработчик ошибок 429 с понятными сообщениями для пользователя

**Статус:** ✅ Решено  
**Версия:** 1.4.1

---

### Проблема: Улучшение безопасности сессий (временные ID и cookie)
**Подпроект:** web_app_WebChip  
**Описание:** Для временных ID неавторизованных пользователей использовался MD5, настройки cookie сессий не были ужесточены.

**Решение:**
- В функции `get_temp_user_id()` MD5 заменён на SHA-256 для генерации `temp_user_id`
- Добавлены безопасные настройки сессий: `SESSION_COOKIE_SECURE`, `SESSION_COOKIE_HTTPONLY`, `SESSION_COOKIE_SAMESITE = 'Lax'`, `PERMANENT_SESSION_LIFETIME = timedelta(hours=8)`

**Статус:** ✅ Решено  
**Версия:** 1.4.2

---

### Проблема: CSRF защита для всех форм и AJAX запросов
**Подпроект:** web_app_WebChip  
**Описание:** Необходимо добавить защиту от CSRF атак для всех форм и AJAX запросов.

**Решение:**
- Добавлен Flask-WTF с CSRFProtect
- CSRF токены добавлены во все HTML формы (login, register, search, forgot_password, reset_password, inventory, cart)
- CSRF токены добавлены во все AJAX запросы (update_profile, update_user, delete_user, add_to_cart, update_cart_item, remove_from_cart)
- Добавлена валидация входных данных с защитой от XSS (escape HTML)
- Реализована санитизация текстовых полей

**Статус:** ✅ Решено  
**Версия:** 1.4.0

---

### Проблема: Неправильная логика поиска по шифру кристалла
**Подпроект:** web_app_WebChip  
**Описание:** При поиске по шифру кристалла (например, "315") возвращались результаты, которые не содержат искомую последовательность символов (например, "HJB308").

**Причина:** Использовалась неправильная логика поиска, которая находила отдельные символы вместо последовательности.

**Решение:** Изменена логика поиска на использование `ILIKE` с паттерном `%{search_pattern}%` для поиска точного вхождения последовательности символов. Теперь "315" найдет HJB315, HJB0315, HJB3150, но не найдет HJB308.

**Статус:** ✅ Решено  
**Версия:** 1.3.9

---

### Проблема: Логотип не кликабелен
**Подпроект:** web_app_WebChip  
**Описание:** Пользователь не может вернуться на главную страницу, кликнув на логотип.

**Решение:** Добавлен `onclick="window.location.href='/'"` во все шаблоны (home.html, search.html, profile.html, manage_users.html, cart.html, inventory.html, inflow.html, outflow.html, refund.html). Добавлен визуальный эффект при наведении (opacity: 0.8, cursor: pointer).

**Статус:** ✅ Решено  
**Версия:** 1.3.8

---

### Проблема: ForeignKeyViolation при удалении пользователя администратором
**Подпроект:** web_app_WebChip  
**Описание:** При попытке удалить пользователя администратором возникала ошибка `psycopg2.errors.ForeignKeyViolation` из-за того, что таблица `user_logs` все еще ссылалась на удаляемого пользователя.

**Причина:** В таблице `user_logs` существовали записи с foreign key на удаляемого пользователя.

**Решение:** Модифицирована функция `delete_user` для предварительного удаления всех связанных записей из таблиц `user_logs` и `cart` перед удалением пользователя из таблицы `users`.

**Статус:** ✅ Решено  
**Версия:** 1.3.7

---

### Проблема: Запрос на вход при поиске без логина
**Подпроект:** web_app_WebChip  
**Описание:** После выбора партии и нажатии на кнопку "Найти" без логина поступал запрос на вход на всех трех складах.

**Причина:** В функции `search()` была проверка `if 'user_id' not in session:` для POST запросов, которая блокировала неавторизованный поиск.

**Решение:** Удалена проверка `user_id` в сессии для POST запросов в функции `search()`, что позволяет неавторизованным пользователям выполнять поиск.

**Статус:** ✅ Решено  
**Версия:** 1.3.6

---

### Проблема: Хранение паролей в открытом виде
**Подпроект:** web_app_WebChip  
**Описание:** Пароли пользователей хранились в базе данных в открытом виде, что представляло серьезную угрозу безопасности.

**Решение:** 
- Реализовано хеширование паролей через `werkzeug.security.generate_password_hash`
- Обновлена функция `register` для хеширования паролей при регистрации
- Обновлена функция `login` для проверки хешированных паролей через `check_password_hash`
- Создан скрипт миграции `migrate_passwords_to_hash.py` для хеширования существующих паролей
- Расширена колонка `password` в таблице `users` с VARCHAR(128) до TEXT для поддержки длинных хешей

**Статус:** ✅ Решено  
**Версия:** 1.3.6
