# Changelog

Все изменения в этом проекте будут задокументированы в этом файле.
Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.1.0/), проект использует [SemVer](https://semver.org/spec/v2.0.0.html).

## [1.4.23] - 2025-12-17

### Added
- Интеграция телеграм-бота в основное Flask приложение (модуль `telegram_bot.py`)
- Телеграм-бот использует общий пул подключений к БД из Flask приложения
- Телеграм-бот использует общую систему логирования из Flask приложения
- Разделители между складами в выводе телеграм-бота (линии `─` * 30)
- Разделители между разными кристаллами в выводе телеграм-бота (линии `=` * 50)
- Поддержка отображения всех трех складов, даже если информация отсутствует ("Информация отсутствует")

### Changed
- Телеграм-бот запускается в отдельном daemon потоке внутри Flask приложения
- Улучшено форматирование вывода телеграм-бота для лучшей читаемости
- Исправлена инициализация пула подключений к БД при старте приложения
- Улучшена обработка ошибок SQL запросов (COUNT query с JOIN'ами)

### Fixed
- Исправлена ошибка "name 'init_db_pool' is not defined" при загрузке списка производителей
- Исправлена ошибка SQL "missing FROM-clause entry for table 'cons'" в COUNT запросе поиска
- Улучшена логика вставки JOIN'ов в упрощенные SQL запросы для пагинации
- Добавлена защита от ошибок при использовании logger до полной инициализации Flask приложения

### Deployment
- Подготовлена Docker конфигурация для объединенного развертывания (веб-приложение + телеграм-бот)
- Обновлен Dockerfile для включения телеграм-бота
- Обновлен docker-compose.yml для единого сервиса

## [1.4.22] - 2025-12-17

### Added
- Создана API документация в формате Markdown (`web_app_WebChip/API_DOCUMENTATION.md`)
- Создано руководство пользователя (`USER_GUIDE.md`) с подробными инструкциями по использованию системы
- Создана документация по развертыванию (`DEPLOYMENT.md`) с инструкциями для локального, Docker и production развертывания

### Documentation
- API документация включает описание всех REST API endpoints с параметрами, примерами и кодами состояния
- Руководство пользователя содержит пошаговые инструкции по всем функциям системы, включая поиск, корзину, управление складом и пользователями
- Документация по развертыванию включает инструкции для различных сценариев развертывания, настройки переменных окружения, мониторинга и устранения неполадок
- Обновлен README.md с ссылками на новую документацию

## [1.4.21] - 2025-12-17

### Added
- Создан модуль `logging_config.py` для расширенной конфигурации логирования
- Добавлена поддержка структурированного логирования в JSON формате
- Добавлено файловое логирование с автоматической ротацией (app.log и errors.log)
- Реализован расширенный форматтер (ExtendedFormatter) с дополнительными полями (user_id, ip_address, request_id, endpoint, method, status_code, duration_ms)
- Добавлен middleware для логирования всех HTTP запросов с request_id и метриками
- Автоматическое логирование ошибок (status_code >= 400) и медленных запросов (>1000ms)
- Опциональное добавление request_id в заголовки ответов (X-Request-ID)

### Changed
- Обновлена функция `setup_logging()` в app.py для использования нового модуля logging_config
- Логирование запросов теперь включает request_id, user_id, ip_address, endpoint, method, status_code, duration_ms
- Файловое логирование теперь разделено на общие логи (app.log) и только ошибки (errors.log)

### Configuration
- Новая переменная окружения `LOG_JSON_FORMAT` - использовать JSON формат логов (по умолчанию false)
- Новая переменная окружения `LOG_LEVEL` - уровень логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL (по умолчанию INFO)
- Новая переменная окружения `LOG_DIR` - директория для файлов логов (по умолчанию logs/ в корне проекта)
- Новая переменная окружения `LOG_ALL_REQUESTS` - логировать все запросы, а не только ошибки и медленные (по умолчанию false)
- Новая переменная окружения `INCLUDE_REQUEST_ID_HEADER` - добавлять X-Request-ID в заголовки ответов (по умолчанию false)

### Monitoring
- Улучшена трассируемость запросов за счет уникального request_id для каждого запроса
- Добавлены метрики длительности выполнения запросов
- Улучшено логирование для отладки и мониторинга приложения

## [1.4.20] - 2025-12-17

### Added
- Добавлена структура тестов (папка tests/) с использованием pytest
- Добавлены базовые unit-тесты для аутентификации (test_auth.py)
- Добавлены тесты для REST API endpoints (test_api.py)
- Добавлены тесты для основных маршрутов приложения (test_routes.py)
- Создан conftest.py с фикстурами для тестирования Flask приложения
- Создан pytest.ini с конфигурацией pytest и маркерами для категоризации тестов
- Добавлен README.md в папке tests/ с инструкциями по запуску тестов
- Добавлены pytest, pytest-cov, pytest-mock в requirements.txt

### Testing
- Покрытие тестами основных функций: аутентификация, API endpoints, маршруты
- Тесты проверяют стандартный формат ответов API
- Тесты проверяют требования авторизации для защищенных страниц
- Поддержка запуска тестов с покрытием кода (--cov)

## [1.4.19] - 2025-12-17

### Added
- Реализована REST API структура с версионированием (/api/v1/)
- Добавлен endpoint GET /api/v1/search для поиска кристаллов с фильтрами и пагинацией
- Добавлен endpoint GET /api/v1/chip-codes для получения списка шифров кристаллов
- Добавлен endpoint GET /api/v1/manufacturers для получения списка производителей
- Добавлен endpoint GET /api/v1/lots для получения списка партий
- Добавлен endpoint GET /api/v1/cart для получения корзины пользователя
- Добавлен endpoint DELETE /api/v1/cart/<item_id> для удаления товара из корзины
- Добавлена стандартизированная функция `api_response()` для единообразных ответов API
- Все ответы API имеют стандартный формат с полями success, version, data, message, errors

### API
- REST API доступен по префиксу /api/v1/
- Поддержка пагинации в GET /api/v1/search (параметры page, per_page)
- Поддержка фильтров в GET /api/v1/search (warehouse, chip_name, manufacturer, lot)
- Все endpoints возвращают JSON с единообразным форматом

## [1.4.18] - 2025-12-17

### Added
- Добавлено логирование медленных SQL запросов (> 1 секунды) с указанием времени выполнения
- Добавлена поддержка `EXPLAIN ANALYZE` для анализа планов выполнения запросов (параметр `explain_analyze` в `execute_query()`)
- Оптимизирован COUNT запрос для пагинации: создается упрощенная версия без JOIN справочников для ускорения подсчета

### Performance
- Значительно ускорен подсчет общего количества результатов поиска за счет оптимизированного COUNT запроса
- Улучшена производительность пагинации при большом количестве результатов
- Добавлено автоматическое логирование времени выполнения всех SQL запросов

### Changed
- Функция `execute_query()` теперь принимает параметр `explain_analyze` для анализа планов выполнения
- COUNT запрос для пагинации теперь использует упрощенную структуру без JOIN справочников (n_chip, pr, lot добавляются только при необходимости для фильтров)

## [1.4.17] - 2025-12-17

### Added
- Реализована пагинация для страницы поиска
- Добавлена возможность выбора количества результатов на странице (25, 50, 100, 200)
- Добавлен интерфейс пагинации с навигацией по страницам и информацией о количестве результатов
- Поддержка GET параметров для навигации по страницам (page, per_page)

### Changed
- Поиск теперь возвращает результаты с пагинацией (по умолчанию 50 на странице)
- При новом поиске автоматически показывается первая страница результатов
- Улучшена производительность при большом количестве результатов за счет LIMIT/OFFSET

### UX
- Добавлена информация о количестве показанных результатов (например, "Показано 1-50 из 250 результатов")
- Улучшена навигация: показываются соседние страницы, первая и последняя страницы
- Визуально выделена текущая страница в пагинации

## [1.4.16] - 2025-12-17

### Added
- Создан SQL скрипт `create_indexes.sql` для создания индексов в базе данных
- Создан Python скрипт `apply_indexes.py` для автоматического применения индексов
- Добавлены индексы для всех таблиц invoice (invoice, invoice_p, invoice_f) по статусу, дате, item_id и внешним ключам
- Добавлены индексы для всех таблиц consumption (consumption, consumption_p, consumption_f) по item_id, дате и внешним ключам
- Добавлены составные индексы для ускорения GROUP BY запросов
- Добавлены индексы для справочных таблиц (pr, lot, n_chip, tech, wafer, quad, in_lot, start_p, stor, cells, chip, pack)
- Добавлен индекс для текстового поиска по n_chip (LOWER(n_chip))
- Добавлены индексы для таблицы cart по user_id, warehouse_type, item_id
- Добавлены индексы для таблицы users по username, email, is_admin, is_blocked

### Performance
- Значительно ускорены JOIN операции за счет индексов на внешних ключах
- Ускорена фильтрация по статусу и дате в таблицах invoice и consumption
- Ускорены GROUP BY запросы за счет составных индексов
- Ускорен текстовый поиск по шифрам кристаллов
- Улучшена производительность работы с корзиной пользователей

## [1.4.15] - 2025-12-17

### Added
- Реализовано кэширование часто запрашиваемых данных (списки производителей, партий, шифров кристаллов)
- Добавлена функция `get_cached_or_execute()` для кэширования результатов запросов с TTL (time-to-live)
- Добавлена функция `clear_cache()` для очистки кэша при изменении справочных данных
- Автоматическая очистка кэша при добавлении новых записей в справочные таблицы (pr, lot, n_chip)

### Changed
- Оптимизированы запросы к БД для получения списков производителей и партий через кэш (TTL = 10 минут)
- Оптимизирован API endpoint `/api/get_chip_codes` через кэширование (TTL = 5 минут для фильтрованных запросов, 10 минут для популярных)
- Оптимизирован API endpoint `/api/get_lots` через кэширование (TTL = 10 минут)

### Performance
- Уменьшена нагрузка на БД за счет кэширования часто запрашиваемых справочных данных
- Улучшена производительность страниц поиска и инвентаризации

## [1.4.14] - 2025-12-16

### Added
- Реализован пул подключений к БД (ThreadedConnectionPool) для улучшения производительности
- Пул подключений с настройками: minconn=1, maxconn=20
- Автоматическая инициализация пула при старте приложения
- Автоматическое закрытие пула при завершении приложения через atexit

### Changed
- Функция `get_db_connection()` теперь получает подключение из пула вместо создания нового
- Функция `execute_query()` возвращает подключение в пул вместо закрытия
- Все функции обработки файлов (inflow, outflow, refund) используют пул подключений
- Улучшена производительность: экономия 7-15 ms на каждый SQL запрос

### Performance
- Переиспользование подключений к БД вместо создания новых для каждого запроса
- Снижение нагрузки на PostgreSQL при высокой нагрузке
- Улучшение масштабируемости приложения

## [1.4.13] - 2025-12-16

### Fixed
- Исправлена работа кнопки "Сохранить" в корзине: индикатор загрузки больше не зависает, количество корректно обновляется
- Исправлена работа кнопки "Удалить" в корзине: подтверждение и удаление теперь выполняются корректно
- Добавлен CSRF meta-тег в `cart.html` для корректной работы AJAX-запросов
- Исправлены оставшиеся ошибки отступов и логики в обработчиках `update_cart_item`, `remove_from_cart` и `login`

### Changed
- Добавлено подробное логирование запросов к эндпоинтам `update_cart_item` и `remove_from_cart` для упрощения диагностики

## [1.4.12] - 2025-12-16

### Added
- Модальные окна подтверждения для критичных действий
- Подтверждение при удалении элемента из корзины
- Подтверждение при очистке всей корзины
- Подтверждение при удалении пользователя администратором
- Подтверждение при снятии прав администратора у самого себя
- Универсальная функция `confirmAction()` для создания модальных диалогов
- Поддержка закрытия модальных окон по клику на фон, кнопку "Отмена" и клавишу Esc

### Changed
- Стандартные `confirm()` заменены на стильные модальные окна с улучшенным UX
- Улучшена доступность: фокус автоматически устанавливается на кнопку "Отмена"

### UX
- Более понятные и информативные сообщения подтверждения
- Визуально привлекательные модальные окна с анимацией
- Возможность закрыть подтверждение клавишей Esc

## [1.4.11] - 2025-12-16

### Added
- Клавиатурные сокращения для всех основных страниц
- Enter в полях поиска (search.html) - выполняет поиск
- Enter в форме логина (login.html) - отправляет форму входа
- Enter в полях количества корзины (cart.html) - сохраняет изменения
- Ctrl+S или Cmd+S - сохранить изменения (cart.html, profile.html, manage_users.html)
- Esc - закрыть flash-сообщения и toast-уведомления на всех страницах
- Esc в manage_users.html - закрыть форму редактирования пользователя

### UX
- Улучшена навигация и работа с формами через клавиатуру
- Пользователи могут работать быстрее, не используя мышь для базовых операций

## [1.4.10] - 2025-12-16

### Fixed
- Исправлена критическая ошибка в функции поиска: фильтры не применялись, если не был выбран фильтр по партии
- Исправлен отступ для блока `if filter_conditions:` - теперь фильтры применяются корректно во всех случаях

### Changed
- Улучшена логика применения фильтров в функции search() - фильтры теперь работают независимо друг от друга

## [1.4.9] - 2025-12-16

### Fixed
- Исправлена проблема с накоплением flash-сообщений на странице логина
- Улучшена функция logout() - теперь используется session.clear() для полной очистки сессии
- Добавлено автоматическое скрытие flash-сообщений через 5 секунд
- Добавлена кнопка закрытия (×) для каждого flash-сообщения на странице логина

### UX
- Более удобное отображение уведомлений на странице логина
- Пользователь может закрыть сообщения вручную или дождаться автоматического скрытия

## [1.4.8] - 2025-12-16

### Added
- API endpoint `/api/get_chip_codes` для получения списка уникальных шифров кристаллов
- HTML5 datalist для автодополнения шифров кристаллов в полях поиска
- JavaScript для динамической загрузки списка шифров с фильтрацией по введенному тексту
- Подсказки (title атрибуты) для всех полей ввода в формах поиска и инвентаризации

### Changed
- Поле ввода шифра кристалла в search.html теперь поддерживает автодополнение через datalist
- Поле ввода шифра кристалла в inventory.html теперь поддерживает автодополнение через datalist
- Добавлены title атрибуты с описаниями для всех полей ввода (производитель, партия, шифр кристалла)
- Оптимизирована загрузка списка шифров: запрос отправляется с задержкой 300ms после окончания ввода

### UX
- Улучшенный пользовательский опыт при поиске: пользователь видит подсказки при вводе шифра кристалла
- Автодополнение помогает избежать опечаток и ускоряет ввод
- Подсказки при наведении мыши объясняют назначение каждого поля

## [1.4.7] - 2025-12-16

### Added
- Система toast-уведомлений для всех шаблонов (замена alert())
- Улучшенная обработка AJAX ошибок с использованием toast-уведомлений
- Унифицированная функция showToast() во всех основных шаблонах

### Changed
- Заменены все alert() на toast-уведомления в основных шаблонах:
  - profile.html - toast для всех сообщений об ошибках и успехе
  - cart.html - toast для обновления количества, удаления, экспорта
  - search.html - toast для добавления в корзину и ошибок загрузки партий
  - manage_users.html - toast для обновления и удаления пользователей
- Улучшена обработка ошибок AJAX (catch блоки) с понятными сообщениями для пользователя
- Добавлены сообщения об ошибках подключения к интернету

### UX
- Более удобные уведомления без блокирующих диалогов
- Автоматическое исчезновение уведомлений через несколько секунд
- Визуальное различие типов уведомлений (success, error, warning, info)

## [1.4.6] - 2025-12-16

### Added
- Клиентская валидация форм с использованием HTML5 атрибутов (pattern, minlength, maxlength, title)
- Система toast-уведомлений для замены alert() в формах регистрации и восстановления пароля
- Валидация в реальном времени для полей паролей (проверка совпадения)
- Визуальная обратная связь для валидных/невалидных полей (цвет границы)

### Changed
- Улучшена валидация в register.html (заменены alert() на toast-уведомления и поля ошибок)
- Добавлена HTML5 валидация в login.html (pattern для username, minlength/maxlength)
- Улучшена валидация в profile.html (проверка паролей, email pattern, валидация в реальном времени)
- Улучшена валидация в forgot_password.html (заменены alert() на toast-уведомления)

### UX
- Более удобная валидация форм с моментальной обратной связью
- Понятные сообщения об ошибках под полями ввода
- Автодополнение для полей username и password

## [1.4.5] - 2025-12-16

### Added
- Защита от перечисления пользователей в функции login
- Задержка 500ms перед возвратом ошибки при неверных данных для замедления брутфорса
- Защита от перечисления пользователей в функции forgot_password (всегда показывается форма)

### Changed
- Всегда показывается одинаковое сообщение об ошибке при неверном логине/пароле (независимо от причины)
- Убрано специальное сообщение для заблокированных пользователей (защита от утечки информации)
- Проверка блокировки пользователя объединена с проверкой пароля
- В forgot_password всегда показывается форма с секретным вопросом (даже для несуществующих пользователей)

### Security
- Предотвращена утечка информации о существовании пользователей через разные сообщения об ошибках
- Добавлена задержка для замедления брутфорса паролей

## [1.4.4] - 2025-12-16

### Added
- Ограничение размера загружаемых файлов (10 MB) для защиты от DoS атак
- Конфигурация `MAX_CONTENT_LENGTH` в Flask для автоматической проверки размера
- Обработчик ошибки 413 (RequestEntityTooLarge) с понятными сообщениями
- Проверка размера файла в функциях `/inflow`, `/outflow`, `/refund` перед обработкой
- Логирование попыток загрузки файлов, превышающих лимит

### Changed
- Все функции загрузки файлов теперь проверяют размер файла перед обработкой

## [1.4.3] - 2025-12-16

### Added
- Валидация имен таблиц и столбцов (whitelist) для защиты от SQL injection
- Функции `validate_table_name()` и `validate_column_name()` для проверки имен таблиц и столбцов
- Whitelist разрешенных таблиц (24 таблицы) и столбцов (15 столбцов)
- Валидация применяется ко всем динамическим именам таблиц и столбцов в SQL запросах

### Changed
- Функции `get_or_create_id()` и `get_reference_id()` теперь валидируют имена таблиц и столбцов
- Все локальные функции `get_or_create_id_with_cursor()` и `get_reference_id_with_cursor()` используют валидацию
- Все использования `invoice_table` и `consumption_table` валидируются через `validate_table_name()`
- Унифицирована кнопка "Главное меню" во всех шаблонах (синий цвет, как у кнопки "Выйти")

## [1.4.2] - 2025-12-16

### Added
- Полноценная система аудита действий пользователей (Audit Log)
- Таблица `audit_log` с полями для отслеживания действий (IP, user agent, детали)
- Логирование критичных действий: login, logout, update, delete, export, file_upload
- SQL скрипт `create_audit_log.sql` для создания таблицы с индексами

### Changed
- Улучшена функция `log_user_action` с поддержкой IP адреса и User-Agent
- Все действия пользователей теперь логируются с полным контекстом
- Обратная совместимость с существующими вызовами `log_user_action` сохранена
 - Улучшена безопасность сессий: SHA-256 для временных ID, безопасные настройки cookie (SECURE, HTTPONLY, SAMESITE, время жизни сессии)

### Fixed
- Исправлены ошибки отступов (IndentationError) в функциях inflow, outflow, refund, search, add_to_cart
- Исправлены отступы для проверки GelPack колонок в функциях загрузки файлов
- Исправлены отступы для params_search и filter_conditions в функции search
- Исправлены отступы в блоке else функции add_to_cart для склада кристаллов

## [1.4.1] - 2025-12-16

### Added
- Rate limiting для защиты от брутфорса паролей
- Добавлен Flask-Limiter в зависимости
- Ограничение: 5 попыток входа в минуту с одного IP
- Общие ограничения: 200 запросов в день, 50 в час на все эндпоинты
- Обработчик ошибок 429 с понятными сообщениями для пользователя

## [1.4.0] - 2025-12-16

### Added
- CSRF protection для всех форм и AJAX запросов
- Добавлен Flask-WTF в зависимости
- CSRF токены во все HTML формы (login, register, search, forgot_password, reset_password, inventory, cart)
- CSRF токены во все AJAX запросы (update_profile, update_user, delete_user, add_to_cart, update_cart_item, remove_from_cart)
- Валидация входных данных (username, email, password, secret_question, secret_answer)
- Функции валидации с защитой от XSS (escape HTML)
- Санитизация текстовых полей

### Fixed
- Исправлены ошибки отступов в коде (inflow, outflow, refund, add_to_cart, export)
- Исправлена логика поиска по шифру кристалла (точное совпадение последовательности символов)

## [1.3.9] - 2025-12-16

### Fixed
- Исправлен поиск по шифру кристалла - теперь ищет точное вхождение последовательности символов (например, "315" найдет HJB315, HJB0315, HJB3150, но не найдет HJB308)
- Исправлены ошибки индентации в коде (строки 412, 507-512, 605-607, 799-801, 1077, 1365, 1373, 1589)

### Changed
- Улучшена логика поиска по шифру кристалла для более точного соответствия
- Добавлено логирование поисковых запросов для диагностики

## [1.3.8] - 2025-12-16

### Changed
- Логотип во всех шаблонах теперь кликабелен и ведет на главную страницу
- Добавлен визуальный эффект при наведении на логотип (opacity: 0.8)
- Улучшена навигация - пользователи могут быстро вернуться на главную страницу кликом по логотипу

## [1.3.7] - 2025-12-16

### Added
- Добавлен личный кабинет пользователя (`/profile`) с возможностью редактирования всех данных
- Пользователь может изменить имя пользователя, email, пароль, секретный вопрос и ответ
- Имя пользователя в правом верхнем углу теперь кликабельно и ведет в личный кабинет
- Секретный ответ автоматически хешируется при сохранении в личном кабинете

### Fixed
- Исправлена ошибка удаления пользователя администратором - теперь сначала удаляются связанные записи из `user_logs` и `cart`
- Исправлена проверка секретных ответов - теперь принимаются только захешированные ответы (безопасность)
- Исправлена проблема с кодировкой email уведомлений (UTF-8 для кириллицы)
- Исправлена проверка паролей - добавлена поддержка форматов `scrypt:` и `pbkdf2:`
- Исправлено отображение flash сообщений на странице входа
- Улучшена обработка ошибок при восстановлении пароля

### Changed
- Улучшен дизайн личного кабинета - белый header с синей нижней границей
- Все шаблоны обновлены - имя пользователя теперь ссылка на профиль

## [1.3.6] - 2025-12-12

### Added
- Добавлен модуль восстановления забытого пароля через секретный вопрос
- При регистрации пользователь задает свой секретный вопрос и ответ для восстановления пароля
- Созданы страницы `/forgot_password` и `/reset_password` для восстановления пароля
- Добавлена ссылка "Забыли пароль?" на странице входа

### Security
- **КРИТИЧНО:** Реализовано хеширование паролей через `werkzeug.security` при регистрации и сбросе пароля
- **КРИТИЧНО:** Исправлен SECRET_KEY - теперь автоматически генерируется если не установлен в .env
- **КРИТИЧНО:** Выполнена миграция всех существующих паролей на хеширование
- Ответ на секретный вопрос хранится в хешированном виде для безопасности
- Добавлена защита от перечисления пользователей (единые сообщения об ошибках)
- Реализована обратная совместимость со старыми незахешированными паролями до полной миграции

### Changed
- Поле `password` в таблице `users` расширено до типа TEXT для хранения хешированных паролей
- При входе система автоматически определяет тип пароля (хеш или открытый текст) и проверяет соответствующим образом
- Пароли администраторами теперь также хешируются при обновлении

### Fixed
- Исправлена проблема с длиной поля password при миграции паролей
- Улучшена валидация при регистрации (проверка совпадения паролей, минимальная длина)

## [1.3.5] - 2025-12-11

### Changed
- Поиск и корзина теперь доступны без авторизации для неавторизованных пользователей
- Неавторизованные пользователи могут добавлять товары в корзину, просматривать и редактировать корзину без требования входа в систему
- Для неавторизованных пользователей используются временные идентификаторы на основе уникального ID сессии
- Убрана проверка авторизации при отправке POST-запроса в функции поиска (`/search`)

### Fixed
- Исправлен редирект на страницу входа при выполнении поиска без авторизации (удалена проверка `if 'user_id' not in session` для POST-запросов в маршруте `/search`)
- Убраны проверки авторизации для функций поиска, добавления в корзину, просмотра корзины и управления корзиной
- Поиск теперь работает без авторизации на всех трёх складах ("Склад кристаллов", "Склад пластин", "Дальний склад")

## [1.3.4] - 2025-12-11

### Changed
- Унифицирован интерфейс поиска для всех типов складов ("Склад кристаллов", "Склад пластин", "Дальний склад")
- Все склады теперь имеют одинаковые поля фильтрации: производитель, партия, шифр кристалла
- Фильтр по партии теперь доступен для всех типов складов, а не только для склада кристаллов
- Динамическая загрузка партий по выбранному производителю работает для всех типов складов

### Removed
- Удален фильтр по пластине из интерфейса поиска (для унификации с интерфейсом склада кристаллов)

## [1.3.3] - 2025-12-11

### Added
- Добавлена система отправки критических ошибок на email администратору через SMTP
- Поддержка корпоративных SMTP серверов (Yandex, Office365 и др.)
- Добавлены параметры конфигурации: `SMTP_USER`, `ENABLE_EMAIL`, `SMTP_FROM_NAME`
- Автоматический запуск через Waitress WSGI сервер в production режиме
- Защита от рекурсии при ошибках отправки email

### Changed
- Улучшена обработка ошибок: 404 ошибки исключены из отправки на email
- Обновлена документация с инструкциями по настройке SMTP для различных провайдеров

### Fixed
- Исправлена рекурсия в SMTP handler при ошибках отправки email
- Улучшена обработка ошибок SMTP аутентификации

## [1.3.2] - 2025-12-10

### Added
- Добавлен фильтр по пластине для складов "Склад пластин" и "Дальний склад"
- Фильтр по пластине появляется после выполнения поиска и заполняется уникальными значениями из результатов
- Фильтрация таблицы на клиенте при выборе пластины

### Fixed
- Исправлена ошибка SQL: добавлено вычисление `latest_note` в CTE `return_sum_by_item` и `consumption_sum_by_item` для функции `add_to_cart()`

## [1.3.1] - 2025-12-09

### Changed
- Улучшен визуальный дизайн главной страницы:
  - Добавлен 3D эффект для заголовков складов (h1) с объемными тенями и градиентами
  - Кнопки главной страницы оформлены в стеклянном 3D стиле с градиентами, бликами и объемными тенями
- Улучшен интерфейс страницы инвентаризации:
  - Кнопки "Поиск", "Выгрузить в Excel" и "Сырые данные" выровнены по высоте с полем ввода "Шифр Кристалла"

## [1.3.0] - 2025-12-09

### Added
- Добавлена функциональность удаления элементов из корзины через кнопку "Удалить" в каждой строке
- Добавлен динамический фильтр партий (id_lot) на странице поиска для склада кристаллов
- Реализована AJAX-загрузка списка партий при выборе производителя

### Changed
- Улучшен интерфейс корзины:
  - Кнопки "Сохранить" и "Удалить" теперь одинакового размера (90px ширина)
  - Кнопки в столбце "Действия" расположены вертикально с отступом 5px
  - Кнопки действий корзины ("Назад к поиску", "Экспортировать", "Очистить") расположены вертикально с отступом 10px
  - Все кнопки действий корзины выровнены по левому краю
- Обновлен стиль кнопки "Найти" на странице поиска: соответствует стилю кнопки "Перейти в корзину"
- Кнопка "Перейти в корзину" перемещена в одну строку с заголовком "Результаты поиска" (справа)
- Улучшено отображение таблиц: добавлены sticky-заголовки для удобной прокрутки

### Fixed
- Исправлена логика агрегации данных в поиске и корзине: группировка по `item_id`, `id_stor`, `id_cells`
- Исправлено отображение "Место хранения" и "Ячейка хранения": теперь корректно подтягиваются из таблицы `consumption`
- Исправлен расчет "Количество в GelPak": теперь правильно учитываются возвраты
- Исправлена логика работы фильтров поиска: поле "Шифр кристалла" сделано опциональным
- Исправлено отображение sticky-заголовков таблиц: заголовки больше не "висят в воздухе"
- Исправлена проблема с дублированием строк при агрегации по item_id

## [1.2.0] - 2025-12-09

### Added
- Реализована система управления несколькими складами через вкладки на главной странице
- Добавлена поддержка трех типов складов: Склад кристаллов, Склад пластин, Дальний склад
- Реализованы отдельные корзины для каждого типа склада с поддержкой `warehouse_type` в таблице `cart`
- Добавлена специальная логика добавления в корзину для складов пластин и дальнего склада:
  - При добавлении одного кристалла автоматически добавляются все кристаллы с того же wafer из той же партии
  - Автоматический расчет количества на основе остатков
- Реализованы индикаторы загрузки (spinner) для всех форм загрузки файлов (Приход, Расход, Возврат)
- Добавлены визуальные сообщения об успехе/ошибке вместо alert-окон
- Расширена функциональность экспорта корзины с различными форматами для разных типов складов
- Добавлена оптимизация обработки файлов: использование единого подключения к БД и курсора для всех операций
- Расширено логирование ошибок с указанием отсутствующих столбцов в Excel-файлах

### Changed
- Главная страница полностью переработана: добавлены три вкладки для разных складов
- Логотип компании заменен на изображение `logo-electron-mash.webp` на всех страницах
- Обновлена цветовая схема: все кнопки и подписи используют цвет `#007CBB`
- Добавлены отступы по 20px с каждой стороны контента для разрешения 1920x1080
- Обновлена структура экспорта корзины:
  - Для складов пластин и дальнего склада добавлены поля: Размер кристалла, Расход общий
  - Изменен порядок столбцов согласно требованиям
- Оптимизированы SQL-запросы для работы с разными таблицами (`invoice`, `invoice_p`, `invoice_f`, `consumption`, `consumption_p`, `consumption_f`)
- Улучшена обработка опциональных полей при загрузке файлов (GelPack, Упаковка, Место хранения, Ячейка хранения)
- Улучшена обработка ошибок с детальным логированием отсутствующих полей

### Fixed
- Исправлена проблема с отображением таблицы инвентаризации: добавлен столбец "Примечание" в SQL-запрос и шаблон
- Исправлено смещение данных в последних столбцах таблицы инвентаризации
- Исправлена проблема с наездом таблицы на текст (добавлены отступы)
- Исправлена ошибка экспорта в Excel: добавлен столбец "Примечание" в список колонок
- Исправлена оптимизация подключений к БД: устранены множественные подключения при обработке файлов
- Исправлена фильтрация результатов поиска: для складов пластин и дальнего склада скрыты строки с нулевыми остатками
- Исправлена обработка ошибок при загрузке файлов: улучшены сообщения об ошибках и логирование

### Removed
- Удалены кнопки "Возврат" и "Инвентаризация" для вкладок "Склад пластин" и "Дальний склад"
- Скрыты столбцы "Взять на пластине" и "Взять в GelPak" в результатах поиска для складов пластин и дальнего склада

## [1.1.0] - 2025-12-08

### Added
- Созданы файлы контекста (`PROJECT_CONTEXT.md`, `SOLUTIONS_HISTORY.md`, `CHAT_HISTORY.md`, `SYNC_INSTRUCTIONS.md`, `.cursorrules`, `CHANGELOG.md`)
- Главная страница оформлена тремя вкладками (Склад кристаллов/Склад пластин/Дальний склад)
- Добавлена поддержка динамического выбора таблиц БД в зависимости от типа склада

### Changed
- Расширено логирование `/login` и добавлены flash-сообщения на форме входа
- `/login` и `/register` теперь сравнивают имена пользователей в нормализованном виде (нижний регистр, `-` заменён на `_`)
- `/search` логирует параметры формы и итоговый SQL-фильтр для диагностики
- Подключение к БД в `get_db_connection()` теперь использует `DB_NAME` (с запасным `DB_NAME2`)
- Локальный запуск Flask переключён на тестовый порт `8089`

### Fixed
- Исправлена проблема авторизации в Opera (нормализация имен пользователей)

