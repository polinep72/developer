# WSB Portfolio — полный обзор стека бронирования рабочих мест

Этот документ описывает **всю экосистему WSB** (Workspace Booking) внутри монорепозитория `Soft_IPK`:
- все актуальные и исторические проекты по бронированию рабочих мест и оборудования,
- архитектуру связки **Telegram‑ботов** и **веб‑портала**,
- базы данных, уведомления, планировщик,
- версионирование и текущий статус,
- план развития.

Документ намеренно **избыточен**, чтобы служить единой точкой входа в тему WSB.

---

## 1. Состав WSB‑стека

### 1.1. Активные ключевые проекты

- **`WSB/` — Workspace Booking Bot (основной бот нового поколения)**  
  - Каноничный код в каталоге `WSB/wsb_bot/` (корень `WSB/` содержит тонкие прокси‑файлы).
  - Версия по README: **5.1.0**.  
  - Стек: Python 3.10+, `pyTelegramBotAPI`, PostgreSQL, APScheduler, Docker.
  - Назначение: Telegram‑бот для бронирования рабочих мест/оборудования с полноценным управлением бронями и пользователями.

- **`WSB_portal/` — веб‑портал бронирования и аналитики**  
  - FastAPI + Jinja2, Plotly, PostgreSQL (RM), Redis, Docker.
  - Публикуется по адресу: `http://192.168.1.139:8090`.
  - Версия по CHANGELOG и тегам: **0.3.7** (актуальный релиз на 2025‑12‑03).
  - Назначение: веб‑интерфейс для бронирования, администрирования и глубокой аналитики (графики, тепловые карты, рекомендации).


### 1.2. Исторические и экспериментальные реализации WSB

- **`telegram_bot_WorkSpaceBooking/`**  
  - Ранняя/альтернативная реализация бота WSB.
  - Хранит бронирования и пользователей в CSV (`bookings.csv`, `registered_users.csv`, `equipment.csv`).
  - Обладает богатым набором команд (`/booking`, `/cancel`, `/finish`, `/продлить`, `/workspacebookings`, `/datebookings` и др.).
  - Сейчас используется как **исторический прототип** и источник бизнес‑логики.

- **`WSB v.3/`, `WSB v.4/`, `NewBot/`**  
  - Промежуточные/экспериментальные версии WSB.
  - Частично дублируют функциональность нового `WSB` и `telegram_bot_WorkSpaceBooking`.
  - Рекомендуются к формальному переводу в архив (см. план в разделе 8).


### 1.3. Дополнительные связанные проекты

- **`WSB/heatmap_app/`**  
  - Отдельное приложение визуализации тепловой карты (тепловая карта исторически вынесена в отдельный сервис).  
  - В новой архитектуре его функциональность частично перешла в `WSB_portal` (`app/services/heatmap.py`).

- **Проекты интеграции**  
  - `NewBot/` и некоторые другие подпроекты используют **те же БД** и / или схожую модель бронирований.

---

## 2. Архитектура: как вместе работают бот и портал

### 2.1. Общая целивая схема

- **Интерфейсы:**
  - Telegram‑бот (`WSB/wsb_bot` / исторически `telegram_bot_WorkSpaceBooking`).
  - Веб‑портал (`WSB_portal`).

- **Бэкенд и данные:**
  - PostgreSQL: основная БД (для WSB — отдельная БД, для портала — БД `RM` и отдельная БД `equipment` для модуля СИ).
  - APScheduler: централизованный планировщик уведомлений (в боте; в портале — для email‑уведомлений и фоновых задач).
  - Redis: кеш (WSB_portal — тепловые карты, дашборды, каталоги оборудования).

- **Инфраструктура:**
  - Docker / Docker Compose для `WSB_portal` (и потенциально для бота `WSB/wsb_bot`).
  - Переменные окружения через `.env` (DB, SMTP, Redis, JWT, PORTAL_PUBLIC_URL и т.д.).


### 2.2. Разделение ролей

- **WSB‑бот (`WSB/wsb_bot`)**
  - Быстрые, «оперативные» сценарии:
    - пользователь в Telegram → забронировать / отменить / продлить / завершить;
    - получить краткий обзор своих броней;
    - получить напоминания за N минут до начала/окончания.
  - Администрирование «в движении»:
    - подтверждение регистраций,
    - управление пользователями и оборудованием,
    - ручной пересчёт уведомлений.

- **WSB_portal**
  - Администрирование и аналитика:
    - полный обзор броней,
    - календарь бронирований,
    - тепловые карты,
    - расширенная статистика (по оборудованию, по пользователям),
    - рекомендации по перегрузкам.
  - Интерфейсы для СИ (equipment) и управления пользователями.

---

## 3. Детализация WSB_portal

### 3.1. Назначение и сценарии использования

WSB_portal задумывался как **веб‑зеркало и расширение** Telegram‑бота:
- всё, что пользователь может сделать в боте, он может сделать и через веб (создание брони, просмотр истории и т.д.);
- плюс то, чего нет (и неудобно делать) в боте: сложная аналитика, работа с большими таблицами, удобное администрирование.

Сценарии:
- **Пользователь**:
  - зайти под своей учеткой (по телефону/email);
  - забронировать оборудование (форма + тепловая карта);
  - посмотреть свои брони, отменить, просмотреть историю;
  - посмотреть общую историю (графики/тепловые карты) — без доступа к админским функциям.

- **Администратор**:
  - видеть все бронирования;
  - управлять пользователями и оборудованием;
  - анализировать загрузку и принимать решения о расширении парка;
  - использовать модуль СИ (учет средств измерений, испытательного и вспомогательного оборудования, Госреестр).


### 3.2. Структура проекта WSB_portal

Кратко (подробнее есть в `WSB_portal/README.md`):

```text
WSB_portal/
├── app/
│   ├── main.py                 # FastAPI-приложение, маршруты, точка входа
│   ├── templates/
│   │   ├── index.html          # Главная страница с 6 вкладками
│   │   ├── login.html          # Вход
│   │   ├── register.html       # Регистрация
│   │   └── reset_password.html # Восстановление пароля по токену
│   ├── static/
│   │   ├── css/main.css        # Основные стили
│   │   ├── js/main.js          # Логика вкладок, AJAX API, рендер графиков
│   │   └── img/logo.webp       # Логотип ИПК «Электрон‑Маш»
│   └── services/
│       ├── bookings.py         # Логика брони: категории, оборудование, слоты, создание/отмена
│       ├── dashboard.py        # Расширенная аналитика, графики, рекомендации
│       ├── heatmap.py          # Тепловая карта, кеш, учёт таймзоны
│       ├── equipment.py        # Модуль СИ, БД `equipment`
│       ├── auth.py             # JWT‑аутентификация, логин/регистрация/ресет пароля
│       ├── users.py            # CRUD пользователей
│       └── notifications.py    # Email‑уведомления
├── scripts/                    # Утилиты и миграции
│   ├── create_reset_table.py
│   ├── create_notification_settings_table.py
│   ├── create_indexes.py       # Индексы в RM и equipment
│   └── set_temp_passwords.py   # Массовые временные пароли
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
├── PROJECT_CONTEXT.md
├── PROJECT_AUDIT_FULL.md
├── CHANGELOG.md
├── SOLUTIONS_HISTORY.md
├── CHAT_HISTORY.md
└── … (DOCKER_* , *_SETUP.md и др.)
```


### 3.3. Вкладки и функциональность

1. **«Бронирование оборудования»**  
   - Форма: категория → оборудование → дата → время начала → длительность.
   - Интервал: **7:00–22:00**, шаг **30 мин** (учтено в `bookings.py`).
   - Слева — форма, снизу/справа — **тепловая карта** (график Plotly), показывающая занятость по времени.

2. **«Управление бронированием»** (только авторизованные)
   - Таблица всех / своих броней (в зависимости от роли пользователя).
   - Фильтрация по дате, сортировка.
   - Кнопка отмены, статусы (активно, отменено, завершено).

3. **«История бронирований (статистика и графики)»**
   - Подвкладки:
     - Дашборд (сводные показатели);
     - Тепловая карта (исторические данные);
     - Статистика по оборудованию (расширенная аналитика);
     - Статистика по пользователям (расширенная аналитика);
     - Временные паттерны (дни недели, часы);
     - Прогноз загрузки;
     - Рекомендации (системные перегрузки, пиковые инциденты, свежие события).
   - Реализованы: таблицы и графики с подробной статистикой, включая рекомендации по расширению парка.

4. **«Система учета оборудования (СИ)»**
   - 4 подвкладки: СИ, ИО, ВО, Госреестр.
   - Выгрузка и просмотр данных equipment, управление карточками.

5. **«Управление пользователями»** (только админы)
   - CRUD по пользователям, сброс паролей.

6. **«Календарь бронирований»**
   - Месячный календарь, клик по дню → подробности.


### 3.4. Ключевые технические решения в WSB_portal

- **Тепловая карта** (`heatmap.py`):
  - Берёт данные из БД `RM`.
  - Учитывает **часовой пояс** через параметр `LOCAL_TIME_OFFSET_MINUTES` (по умолчанию +180 минут для МСК).
  - Для **сегодняшней даты** кеш отключён → статусы слотов своевременно переходят из «Забронировано» в «В работе».
  - Для прошлых и будущих дат используется Redis‑кеш.

- **Расширенная аналитика** (`dashboard.py` + `main.js`):
  - Метрики по оборудованию: часы, количество бронирований, средняя длительность, загрузка (%), распределения по дням/часам/месяцам, топ пользователей.
  - Метрики по пользователям: суммарные часы, количество броней, разнообразие оборудования, часто используемое оборудование и т.д.
  - Рекомендации: системные перегрузки, пиковые инциденты (дни с 10+ часами использования), выводы по категориям/конкретному оборудованию.

- **UI‑решения**:
  - Графики Plotly адаптируются по размеру контейнера, есть обработка resize.
  - В расширенной статистике блоки выстроены **вертикально**, таблицы имеют горизонтальную прокрутку, чтобы не ломать вёрстку.
  - Верхняя шапка с логотипом ИПК «Электрон‑Маш» закреплена.

- **Docker и инфраструктура**:
  - `docker-compose.yml` поднимает портал и Redis в общей сети, Redis не проброшен наружу (нет конфликтов порта 6379).
  - Созданы вспомогательные скрипты для сборки, запуска и мониторинга логов (в т.ч. PowerShell‑скрипты).


### 3.5. Версионирование WSB_portal

- Используется **SemVer**.
- Ключевые версии:
  - **0.3.5** — восстановление и расширение аналитики, контроль доступа к вкладкам.
  - **0.3.6** — фиксы тепловой карты (учёт часового пояса, отключение кеша для текущего дня), исправление Docker/Redis конфигурации, добавление скриптов мониторинга.
  - **0.3.7** — исправления ошибок отступов и переполнения блоков статистики, доработка таблиц и контейнеров.
- Для релизов заведены теги `v0.3.6`, `v0.3.7`, а также тег‑варианты `wsb_portal-v0.3.x`.

---

## 4. Детализация WSB‑бота (`WSB/`)

### 4.1. Назначение и функциональность

**WSB (Workspace Booking Bot)** — Telegram‑бот, работающий с PostgreSQL и обеспечивающий:
- регистрацию пользователей (через заявки и подтверждение администратора);
- бронирование оборудования (категория → устройство → дата → время);
- управление бронями (просмотр, отмена, продление, завершение);
- просмотр расписания по рабочим местам и по датам;
- автоматические уведомления (до начала и до окончания брони).

### 4.2. Архитектура кода WSB

Структура по README:

```text
WSB/
├── main.py                    # Прокси → wsb_bot/main.py
├── bot_app.py                 # Прокси → wsb_bot/bot_app.py
├── config.py, constants.py
├── database.py, logger.py
├── handlers/                  # Прокси → wsb_bot/handlers/*
├── services/                  # Прокси → wsb_bot/services/*
├── utils/                     # Прокси → wsb_bot/utils/*
└── wsb_bot/                   # Каноничный исходный код
    ├── main.py                # Точка входа
    ├── bot_app.py             # Инициализация bot, db, scheduler
    ├── handlers/              # Команды / колбэки
    ├── services/              # Бизнес‑логика (бронь, уведомления, оборудование, пользователи)
    ├── utils/                 # Клавиатуры, форматирование, время
    ├── states/                # Машина состояний
    └── logs/
```

### 4.3. База данных WSB‑бота

Основные таблицы (по README):

```sql
users (id, users_id, first_name, last_name, fi, date, is_admin, is_blocked)
users_temp (id, users_id, first_name, last_name, fi, date)
categories (id, name)
equipment (id, name, category_id, note)
bookings (id, user_id, equipment_id, time_start, time_end, status, created_at)
```

Логика:
- пользователи регистрируются, заявки ждут подтверждения в `users_temp`;
- администратор переводит заявки в `users`;
- все бронирования живут в таблице `bookings` с полями для начала/конца/статуса.

### 4.4. Планировщик уведомлений APScheduler

- Инициализируется с таймзоной (pytz `Europe/Moscow`).
- Задачи:
  - напоминание до начала брони (`NOTIFICATION_BEFORE_START_MINUTES`);
  - напоминание до окончания (`NOTIFICATION_BEFORE_END_MINUTES`);
  - финальное уведомление/автозавершение.
- Продвинутые детали:
  - решена проблема совместимости `pytz` / `zoneinfo` (нет больше `ZoneInfo.localize` ошибок);
  - добавлена обработка misfire (запуск задач, если просрочка в пределах grace‑периода).

### 4.5. Команды бота

- Пользовательские:
  - `/start`, `/help`, `/booking`, `/mybookings`, `/cancel`, `/finish`, `/extend`, `/workspacebookings`, `/datebookings`.
- Админские:
  - `/adminhelp`, `/add_equipment`, `/manage_equipment`, `/admin_cancel`, `/all`, `/broadcast`, `/users`, `/manage_user`, `/schedule` (обновление расписания уведомлений).

---

## 5. Исторический бот `telegram_bot_WorkSpaceBooking/`

Этот проект представляет **раннюю реализацию WSB**, где все данные хранились в CSV:
- `bookings.csv` — активные брони;
- `registered_users.csv` — пользователи;
- `equipment.csv` — оборудование;
- дополнительные файлы для отмен/завершений.

Особенности:
- богатый набор пользовательских команд (`/booking`, `/cancel`, `/продлить`, `/finish`, `/workspacebookings`, `/datebookings`, `/users`, `/allbookings` и др.);
- все операции — через pandas‑DataFrame и запись в CSV;
- логика бронирований (проверка конфликтов, ограничение по диапазону дат, работа со временем) стала основой современной PostgreSQL‑версии.

Сейчас `telegram_bot_WorkSpaceBooking` имеет **скорее историческую/референсную ценность**:
- как пример UX сценариев и набора команд;
- как источник бизнес‑правил при портировании в `WSB/wsb_bot` и `WSB_portal`.

---

## 6. Связь между WSB‑ботом и WSB_portal

- Общий домен: бронирование рабочих мест/оборудования.
- Общие сущности: пользователи, оборудование, брони, категории.
- Различия в реализации:
  - бот работает напрямую с PostgreSQL (своей БД),
  - портал использует БД `RM` (боевые бронирования по RM) и отдельную БД `equipment` для учета средств измерений.

**Рекомендуемая целевая модель:**
- единый «core»‑модуль (`wsb_core/`), в котором живут:
  - описания сущностей (pydantic‑модели / dataclasses),
  - функции работы с таблицами (репозитории/DAO),
  - общие константы, статусы, бизнес‑правила,
  - утилиты по времени, проверке конфликтов, формированию слотов.
- бот и портал используют этот «core», минимизируя дублирование логики.

---

## 7. Версионирование и теги

### 7.1. WSB_portal

- Версионирование по SemVer, фиксируется в `WSB_portal/CHANGELOG.md`.
- Теги в Git:
  - `v0.3.6`, `v0.3.7` (и теги вида `wsb_portal-v0.3.x`).
- Основной смысл версий:
  - 0.3.5 — восстановление и расширение аналитики;
  - 0.3.6 — тепловая карта, Docker/Redis;
  - 0.3.7 — фиксы интерфейса (таблицы/статистика) и отступов.

### 7.2. WSB‑бот

- В README указана версия **5.1.0** (по сути, «продуктовая» версия бота).
- Отдельный CHANGELOG для бота в текущей структуре не представлен; рекомендуется:
  - завести `WSB/wsb_bot/CHANGELOG.md`;
  - ввести теги вида `wsb-bot-v5.1.0`, `wsb-bot-v5.2.0` и далее по SemVer.

---

## 8. План развития WSB‑стека (предложение)

### 8.1. Архивирование старых реализаций

- Вынести `WSB v.3/`, `WSB v.4/`, `NewBot/`, старые версии heatmap‑приложения в каталог `archive/WSB/` или явно пометить в их README как устаревшие.
- В `WSB_PORTFOLIO.md` держать актуальный список **только рабочих** проектов.

### 8.2. Выделение общего core‑модуля

- Создать каталог `wsb_core/` в `Soft_IPK`:
  - общие модели (User, Equipment, Booking, Category, Status);
  - общие функции по времени/слотам (построение доступных интервалов, проверка конфликтов);
  - общие правила уведомлений (за сколько минут до/после, логика продлений).
- Подключить `wsb_core` в `WSB/wsb_bot` и `WSB_portal`.

### 8.3. Безопасность и эксплуатация WSB_portal

- Реализовать CSRF‑защиту во всех формах (особенно POST‑запросы бронирований и управления пользователями).
- Минимизировать использование `innerHTML` в `main.js`, перейти на `textContent`/шаблоны.
- Усилить политику cookie (secure, httponly) и заголовки безопасности в продакшене.
- Добавить базовые автотесты (pytest) и прогон линтеров перед релизами.

### 8.4. Синхронизация бота и портала

- Чётко описать, какие данные и в какую сторону синхронизируются (бот ↔ портал):
  - пользователи (Telegram ID ↔ web‑аккаунт);
  - брони (общая БД или периодическая синхронизация);
  - статусы (активна/отменена/завершена).
- При необходимости:
  - либо перевести бота на ту же БД, что и портал (RM),
  - либо сделать ETL‑процесс между базами.

### 8.5. Документация

- Обновлять этот файл (`WSB_PORTFOLIO.md`) после каждого крупного изменения:
  - новые версии WSB_portal / WSB‑бота;
  - изменения архитектуры;
  - перенос/архивирование подпроектов.
- В каждом живом подпроекте (бот/портал) держать актуальные:
  - `README.md` (как запустить, окружение);
  - `PROJECT_CONTEXT.md` (архитектура, связи);
  - `CHANGELOG.md` (изменения).

---

## 9. Статус на текущий момент (срез)

- **WSB_portal**: стабилизирован до **0.3.7**, активно используется как основной портал для бронирований и аналитики.
- **WSB/wsb_bot**: основная Telegram‑реализация WSB, версия по README **5.1.0**, активно сопровождается.
- **telegram_bot_WorkSpaceBooking**: исторический проект на CSV, используется как референс‑база по сценариям.
- Исторические WSB‑проекты присутствуют в репозитории, но требуют явного статуса (архив/legacy).

Этот документ должен служить **центральной точкой правды по WSB‑стеку**: при любом новом изменении в боте/портале или при появлении новых связанных подпроектов разделы 1–9 следует обновлять.